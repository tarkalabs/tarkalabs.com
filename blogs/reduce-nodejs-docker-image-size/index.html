<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>How to reduce your Node.js docker image size by 70% · Tarka Labs - Tarka Labs</title><meta name="gridsome:hash" content="f433ad77b8b7359a06b85465332ad833bc750e27"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="viewport" content="width=device-width, initial-scale=1.0"><meta data-vue-tag="ssr" property="og:title" content="How to reduce your Node.js docker image size by 70% · Tarka Labs"><meta data-vue-tag="ssr" property="og:description" content="How to reduce your Node.js docker image size by 70%"><meta data-vue-tag="ssr" property="og:image" content="/assets/img/how-to-reduce.e7347fdf.gif"><meta data-vue-tag="ssr" property="og:image:height" content="627"><meta data-vue-tag="ssr" property="og:image:width" content="1200"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.92f6d0f06feb6aec5e019521ff224fd8.png"><link rel="preload" href="/assets/css/0.styles.7b6ce15b.css" as="style"><link rel="preload" href="/assets/js/app.85c9a121.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--blog-vue.80bca3bd.js" as="script"><link rel="stylesheet" href="/assets/css/0.styles.7b6ce15b.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
    <meta
      name="google-site-verification"
      content="j7cLUK-kxGEpMOY7valSkamH4kQe_l38yMMAXbpk19U"
    />
    <noscript>
      <div class="noscript-container">
        <a href="/" class="noscript-logo">Tarka <br />_Labs</a>
        <div class="noscript-text-container">
          <h1>Uh oh! Looks like <span>JavaScript</span> is disabled.</h1>
          <p>
            Bitman requires <span>JavaScript</span> to fuel his thirst to end
            bad UX and lazy design, which is necessary to give you the best
            viewing experience possible. Please enable it to continue to our
            website.
          </p>
        </div>
      </div>
    </noscript>
  </head>

  <body >
    <div><div id="app" data-server-rendered="true" data-v-b5a9baaa><div data-v-b5a9baaa><div id="banner-section" data-v-b5a9baaa><div class="banner" style="background:;display:none;" data-v-b5a9baaa><div class="layout" data-v-b5a9baaa><div data-v-b5a9baaa></div><div class="hero heading-size-5" style="color:#ffffff;" data-v-b5a9baaa></div><div data-v-b5a9baaa></div></div></div><div data-v-b5a9baaa></div></div><div class="sidebar" data-v-d6d2017e data-v-b5a9baaa><div class="nav" data-v-d6d2017e><div class="fixed" data-v-d6d2017e><a href="/" data-v-9b1a4c9c data-v-d6d2017e> TARKA<br data-v-9b1a4c9c>_LABS </a><div class="menu" data-v-50705736 data-v-d6d2017e><div class="control" style="stroke:black;" data-v-50705736><div class="spinner heading-size-9" data-v-02ea7230 data-v-50705736><span class="side-menu-symbol" data-v-02ea7230><span class="menu-symbol rotate180t90" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span><span class="menu-symbol rotate90t0" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span></span><span style="vertical-align: middle" data-v-02ea7230> menu </span></div><div class="active-page body-jetbrains-size-11 fade-in" data-v-128e5feb data-v-50705736>
  
</div></div><div class="items hidden" data-v-50705736><ul class="main-nav" data-v-04879724 data-v-50705736><div class="primary fadeOut sidebar" data-v-04879724><li data-v-04879724><a href="/genai" data-v-04879724>/GenAI</a></li><li data-v-04879724><a href="https://solutions.tarkalabs.com/design/" target="_self" data-v-04879724>/Design</a></li><li data-v-04879724><a href="/develop" data-v-04879724>/Develop</a></li><li data-v-04879724><a href="/case-studies" data-v-04879724>
        /Case_Studies
      </a></li><li data-v-04879724><a href="/careers" data-v-04879724>/Careers</a></li><li data-v-04879724><a href="/about" data-v-04879724>/About</a></li><li data-v-04879724><a href="/contact" data-v-04879724>/Contact</a></li></div></ul><ul class="sub body-jetbrains-size-11 fadeOut sidebar" data-v-3cc3824e data-v-50705736><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul></div></div><a href="/contact" class="heading-size-9" data-v-573e12d8 data-v-d6d2017e>
  Get in<br data-v-573e12d8>touch<span class="arrow" data-v-573e12d8>-&gt;</span></a></div></div><!----></div><div class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="blog-details-page" data-v-996dafb6><div class="inner-section" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>
        /devops - 4 min read
      </p><h1 class="title" data-v-996dafb6>How to reduce your Node.js docker image size by 70%</h1><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/madhava.695f658a.jpg" alt="Madhava Reddy SV" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Madhava Reddy SV</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            DevOps
          </p></div></div></div><img src="/assets/img/how-to-reduce.e7347fdf.gif" alt="How to reduce your Node.js docker image size by 70%" class="header-img" data-v-996dafb6><div class="toc-wrapper" data-v-996dafb6><h2 class="heading-size-7" data-v-996dafb6>Table of contents</h2><div class="toc" data-v-996dafb6><a href="#content" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/01</p><p data-v-996dafb6>Intro</p></a><a href="#toc-section-1" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/02</p><p data-v-996dafb6>Moving to Alpine images</p></a><a href="#toc-section-2" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/03</p><p data-v-996dafb6>Utilising docker multi-stage build</p></a><a href="#toc-section-3" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/04</p><p data-v-996dafb6>Copying only the production-required Node modules</p></a><a href="#toc-section-4" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/05</p><p data-v-996dafb6>Copying only the required files to the final image</p></a><a href="#toc-section-5" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/06</p><p data-v-996dafb6>Here’s the full nodejs dockerfile at a glance</p></a><a href="#toc-section-6" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/07</p><p data-v-996dafb6>Some tips to improve your build time further</p></a><a href="#toc-section-7" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/08</p><p data-v-996dafb6>All done? Here are some next steps</p></a></div></div><div id="content" class="content" data-v-996dafb6><p>Who wouldn’t love a small production image, right? If you’re looking for a way to make your images smaller, here’s how you can do it. To illustrate this further, I’ve used one of our node images with an initial size of <code class="language-inline-text">1.6GB</code>. By simply following the below mentioned steps, I have reduced its size to <code class="language-inline-text">450MB</code> and made it almost <code class="language-inline-text">~71%</code> more space efficient now.</p>
<h1 id="toc-section-1"><a href="#moving-to-alpine-images" aria-hidden="true"><span class="icon icon-link"></span></a>Moving to Alpine images</h1>
<p>The first step in reducing the image size is to move the base image from Node to Node Alpine. For example, if you’re using Node v16, you can use <code class="language-inline-text">node:16-alpine</code> image as your base image, which will have a size of <code class="language-inline-text">~39MB</code>, instead of a<code class="language-inline-text">node:16</code> image, which would have a size of <code class="language-inline-text">~332MB</code>.</p>
<p>By just changing the base image to Alpine, you can reduce almost <code class="language-inline-text">293MB</code> of size from your final image.</p>
<p>But here’s a note of caution. Although you might reduce the image size, moving to Alpine/slim images might break the application, as these images might not have all the packages like full Node images. Please perform complete end-to-end testing after changing the base image.</p>
<h1 id="toc-section-2"><a href="#utilising-docker-multi-stage-build" aria-hidden="true"><span class="icon icon-link"></span></a>Utilising docker multi-stage build</h1>
<p>Sometimes, you might need to install packages to support building the application. For example, you’ll need to install <code class="language-inline-text">g++</code>, <code class="language-inline-text">make</code> and <code class="language-inline-text">python3</code> so that <code class="language-inline-text">node-gyp</code> can build the native modules.</p>
<p>But you don’t need these packages during the application runtime, so use docker multi-stage build to simply skip these packages in the final image.</p>
<h1 id="toc-section-3"><a href="#copying-only-the-production-required-node-modules" aria-hidden="true"><span class="icon icon-link"></span></a>Copying only the production-required Node modules</h1>
<p>For the application runtime, you don’t need any of the dev dependencies. Instead, you can simply install production node modules.</p>
<p>As <code class="language-inline-text">npm install</code> will download all the node modules, you can do <code class="language-inline-text">npm prune</code> --production to remove all dev dependencies after you build your application. Or else you can simply do npm <code class="language-inline-text">install --only</code> prod if your nodejs application can’t be built explicitly.</p>
<h1 id="toc-section-4"><a href="#copying-only-the-required-files-to-the-final-image" aria-hidden="true"><span class="icon icon-link"></span></a>Copying only the required files to the final image</h1>
<p>Once the project is built, you can simply copy the below mentioned files to the final image. You don’t need dev dependencies or any other intermediate files from the builder stage.</p>
<ul>
<li>Application resources if any</li>
<li>Package.json &#x26; package-lock.json</li>
<li>Production only node_modules from docker builder stage</li>
<li>Build output from docker builder stage</li>
</ul>
<h1 id="toc-section-5"><a href="#heres-the-full-nodejs-dockerfile-at-a-glance" aria-hidden="true"><span class="icon icon-link"></span></a>Here’s the full nodejs dockerfile at a glance</h1>
<div class="gridsome-highlight" data-language="dockerfile"><pre class="language-dockerfile"><code class="language-dockerfile"><span class="token instruction"><span class="token keyword">FROM</span> node:16.4-alpine3.14 <span class="token keyword">as</span> builder</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token comment"># g++ make python3 required by node-gyp</span>
<span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache g++ make python3</span>
<span class="token comment"># Installs required node packages</span>
<span class="token instruction"><span class="token keyword">COPY</span> package*.json .npmrc /app/</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm install</span>
<span class="token comment"># Builds node application</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm run build &amp;&amp; npm prune --production</span>
<span class="token comment"># ==== Final Image</span>
<span class="token instruction"><span class="token keyword">FROM</span> node:16.4-alpine3.14 <span class="token keyword">as</span> final</span>
<span class="token instruction"><span class="token keyword">USER</span> node:node</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token comment"># Copying required resources</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> resources resources</span>
<span class="token comment"># Copying build output</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span> <span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> /app/package*.json ./</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span> <span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> /app/build/ build</span>
<span class="token comment"># Copying production only node modules</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span> <span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> /app/node_modules/ node_modules</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"node"</span>, <span class="token string">"build/src/server.js"</span>]</span></code></pre></div>
<h1 id="toc-section-6"><a href="#some-tips-to-improve-your-build-time-further" aria-hidden="true"><span class="icon icon-link"></span></a>Some tips to improve your build time further</h1>
<ul>
<li>Before copying the entire source code, copying only <code class="language-inline-text">package.json</code>, <code class="language-inline-text">package-lock.json</code> and then running <code class="language-inline-text">npm install</code> will speed up the subsequent builds.</li>
<li>Before copying the build output and node modules, copy the required application resources if you have any. This way, docker won’t rebuild the layer if the file content doesn’t change.</li>
</ul>
<h1 id="toc-section-7"><a href="#all-done-here-are-some-next-steps" aria-hidden="true"><span class="icon icon-link"></span></a>All done? Here are some next steps</h1>
<p>With just the above simple steps, you can reduce your image size by a minimum of 70% or more. Run all your unit and performance tests before you push your image to production.</p>
<ul>
<li>Use the <a href="https://github.com/wagoodman/dive#dive" target="_blank" rel="nofollow noopener noreferrer">Dive</a> tool to see where exactly your image size can be reduced. The tool’s UI visualises which files are created / modified between the layers.</li>
<li>Try to dig deeper into the application dependencies and see if you can remove unused dependencies.</li>
<li>See which node modules have more size using <code class="language-inline-text">du</code> and try to remove the unnecessary ones.</li>
<li>Always try to use specific package(s) instead of the whole package. Ex: <code class="language-inline-text">@aws-sdk/client-s3</code> instead of <code class="language-inline-text">aws-sdk</code>.</li>
<li>If you are thinking about security, moving to <a href="https://github.com/GoogleContainerTools/distroless" target="_blank" rel="nofollow noopener noreferrer">distroless</a> images will reduce your application attack surface significantly.</li>
</ul>
<p>Adding our screenshots of Dive tool for both images.</p>
<figure><img src="/blog/reduce-nodejs-docker-image-size/how-to-reduce_2.webp" alt="Initial image layers and their sizes"><figcaption>Initial image layers and their sizes</figcaption></figure>
<figure><img src="/blog/reduce-nodejs-docker-image-size/how-to-reduce-3.webp" alt="Final image layers and their sizer"><figcaption>Final image layers and their sizer</figcaption></figure>
<hr>
<p>Oh, and this is my very first article. Any feedback is welcome!</p>
<blockquote>
<p>Hello Montreal! We’ll be at the <a href="https://startupfestival.com/" target="_blank" rel="nofollow noopener noreferrer">Startupfest ’22</a> all three days, so drop by and say hi. We’d love to see what you’re building, and early birds get a free (limited) design audit or tech consultation. DM us on Twitter <a href="https://twitter.com/tarkalabs" target="_blank" rel="nofollow noopener noreferrer">(@tarkalabs)</a> and let’s talk.</p>
</blockquote>
</div><hr data-v-996dafb6><div class="inner-section" data-v-996dafb6><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/madhava.695f658a.jpg" alt="Madhava Reddy SV" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Madhava Reddy SV</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            DevOps
          </p></div></div><p class="body-opensans-size-9" data-v-996dafb6>He is still thinking what to write about him</p><div class="social-links" data-v-996dafb6><!----><!----><!----></div></div><hr data-v-996dafb6><div class="related-articles" data-v-996dafb6><div class="flex-space-between" data-v-996dafb6><p class="heading-size-7" data-v-996dafb6>_related articles</p><a href="/blogs" class="heading-size-9 underline" data-v-996dafb6>View all</a></div><div class="flex-space-between blog-card-wrapper" data-v-996dafb6><a href="/blogs/opentext-magellan-aks-unofficial-deployment-guide" class="blog-card" data-v-996dafb6><img src="/assets/img/default-cover.55254b66.png" alt="OpenText Magellan and AKS: An unofficial deployment guide" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/devops</p><h3 data-v-996dafb6>OpenText Magellan and AKS: An unofficial deployment guide</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Shamil Siddique   11 min read
            </p></div></a><a href="/blogs/aws-ecs-monitoring-solution" class="blog-card" data-v-996dafb6><img src="/assets/img/cover.48fab8a3.gif" alt="The only in-depth AWS ECS monitoring solution you'll need" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/devops</p><h3 data-v-996dafb6>The only in-depth AWS ECS monitoring solution you'll need</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Madhava Reddy SV   6 min read
            </p></div></a></div></div><div class="lets-talk" data-v-188e6a71><div class="message heading-size-7" data-v-188e6a71>
    Let’s build digital solutions together.
  </div><div class="action-container" data-v-188e6a71><div class="action-button heading-size-5" data-v-188e6a71><div data-v-188e6a71>Get in touch</div><div class="arrow" data-v-188e6a71>-&gt;</div></div><img src="/assets/img/talk.71d1d2f3.svg" alt="Lenny Face" data-v-188e6a71></div></div></div></div><div data-v-996dafb6></div></div><div id="footer" class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="site-footer" data-v-0a037a4b data-v-b5a9baaa><ul class="main-nav footer" data-v-04879724 data-v-0a037a4b><div class="primary fadeIn" data-v-04879724><li data-v-04879724><a href="/genai" data-v-04879724>/GenAI</a></li><li data-v-04879724><a href="https://solutions.tarkalabs.com/design/" target="_self" data-v-04879724>/Design</a></li><li data-v-04879724><a href="/develop" data-v-04879724>/Develop</a></li><li data-v-04879724><a href="/case-studies" data-v-04879724>
        /Case_Studies
      </a></li><li data-v-04879724><a href="/careers" data-v-04879724>/Careers</a></li><li data-v-04879724><a href="/about" data-v-04879724>/About</a></li><li data-v-04879724><a href="/contact" data-v-04879724>/Contact</a></li></div></ul><div class="subnav" data-v-0a037a4b><ul class="sub body-jetbrains-size-11 footer fadeIn" data-v-3cc3824e data-v-0a037a4b><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul><div data-v-fae945d8 data-v-0a037a4b><a href="https://twitter.com/tarkalabs" target="_blank" rel="noopener" class="external" data-v-fae945d8>Twitter</a><a href="https://in.linkedin.com/company/tarka-labs" target="_blank" rel="noopener" class="external" data-v-fae945d8>LinkedIn</a></div><div class="sedin" data-v-0a037a4b><a href="https://sedintechnologies.com/" target="_blank" rel="noopener" class="external" data-v-0a037a4b>Tarka Labs is a division of Sedin Technologies</a></div></div></div></div><div data-v-996dafb6></div></div></div></div></div>
    <script src="/assets/js/app.85c9a121.js" defer></script><script src="/assets/js/page--src--templates--blog-vue.80bca3bd.js" defer></script><script data-vue-tag="ssr" src="https://unpkg.com/@lottiefiles/lottie-player@0.4.0/dist/lottie-player.js" data-body="true"></script>
  </body>
</html>
