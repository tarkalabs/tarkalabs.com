<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Scaling Royalty Payouts in Music Distribution: Challenges and Solutions from the Frontlines (Part 2) · Tarka Labs - Tarka Labs</title><meta name="gridsome:hash" content="befc11b432811bca2258a5ed9ac12568bf4c1023"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="viewport" content="width=device-width, initial-scale=1.0"><meta data-vue-tag="ssr" property="og:title" content="Scaling Royalty Payouts in Music Distribution: Challenges and Solutions from the Frontlines (Part 2) · Tarka Labs"><meta data-vue-tag="ssr" property="og:description" content="Scaling Royalty Payouts in Music Distribution: Challenges and Solutions from the Frontlines (Part 2)"><meta data-vue-tag="ssr" property="og:image" content="/assets/img/default-cover.55254b66.png"><meta data-vue-tag="ssr" property="og:image:height" content="627"><meta data-vue-tag="ssr" property="og:image:width" content="1200"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.92f6d0f06feb6aec5e019521ff224fd8.png"><link rel="preload" href="/assets/css/0.styles.2c02ec4b.css" as="style"><link rel="preload" href="/assets/js/app.0797a3da.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--blog-vue.80bca3bd.js" as="script"><link rel="stylesheet" href="/assets/css/0.styles.2c02ec4b.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
    <meta
      name="google-site-verification"
      content="j7cLUK-kxGEpMOY7valSkamH4kQe_l38yMMAXbpk19U"
    />
    <noscript>
      <div class="noscript-container">
        <a href="/" class="noscript-logo">Tarka <br />_Labs</a>
        <div class="noscript-text-container">
          <h1>Uh oh! Looks like <span>JavaScript</span> is disabled.</h1>
          <p>
            Bitman requires <span>JavaScript</span> to fuel his thirst to end
            bad UX and lazy design, which is necessary to give you the best
            viewing experience possible. Please enable it to continue to our
            website.
          </p>
        </div>
      </div>
    </noscript>
  </head>

  <body >
    <div><div id="app" data-server-rendered="true" data-v-b5a9baaa><div data-v-b5a9baaa><div id="banner-section" data-v-b5a9baaa><div class="banner" style="background:;display:none;" data-v-b5a9baaa><div class="layout" data-v-b5a9baaa><div data-v-b5a9baaa></div><div class="hero heading-size-5" style="color:#ffffff;" data-v-b5a9baaa></div><div data-v-b5a9baaa></div></div></div><div data-v-b5a9baaa></div></div><div class="sidebar" data-v-d6d2017e data-v-b5a9baaa><div class="nav" data-v-d6d2017e><div class="fixed" data-v-d6d2017e><a href="/" data-v-9b1a4c9c data-v-d6d2017e> TARKA<br data-v-9b1a4c9c>_LABS </a><div class="menu" data-v-50705736 data-v-d6d2017e><div class="control" style="stroke:black;" data-v-50705736><div class="spinner heading-size-9" data-v-02ea7230 data-v-50705736><span class="side-menu-symbol" data-v-02ea7230><span class="menu-symbol rotate180t90" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span><span class="menu-symbol rotate90t0" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span></span><span style="vertical-align: middle" data-v-02ea7230> menu </span></div><div class="active-page body-jetbrains-size-11 fade-in" data-v-128e5feb data-v-50705736>
  
</div></div><div class="items hidden" data-v-50705736><ul class="main-nav" data-v-244aa462 data-v-50705736><div class="primary fadeOut sidebar" data-v-244aa462><li data-v-244aa462><a href="/music-biz" data-v-244aa462>/MusicBiz</a></li><li data-v-244aa462><a href="/genai" data-v-244aa462>/GenAI</a></li><li data-v-244aa462><a href="https://solutions.tarkalabs.com/design/" target="_self" data-v-244aa462>/Design</a></li><li data-v-244aa462><a href="/develop" data-v-244aa462>/Develop</a></li><li data-v-244aa462><a href="/case-studies" data-v-244aa462>
        /Case_Studies
      </a></li><li data-v-244aa462><a href="/careers" data-v-244aa462>/Careers</a></li><li data-v-244aa462><a href="/about" data-v-244aa462>/About</a></li><li data-v-244aa462><a href="/contact" data-v-244aa462>/Contact</a></li></div></ul><ul class="sub body-jetbrains-size-11 fadeOut sidebar" data-v-3cc3824e data-v-50705736><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul></div></div><a href="/contact" class="heading-size-9" data-v-573e12d8 data-v-d6d2017e>
  Get in<br data-v-573e12d8>touch<span class="arrow" data-v-573e12d8>-&gt;</span></a></div></div><!----></div><div class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="blog-details-page" data-v-996dafb6><div class="inner-section" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>
        /web - 5 min read
      </p><h1 class="title" data-v-996dafb6>Scaling Royalty Payouts in Music Distribution: Challenges and Solutions from the Frontlines (Part 2)</h1><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/harman.9bd8c31a.jpg" alt="Harman Sohanpal" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Harman Sohanpal</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            Developer
          </p></div></div></div><img src="/assets/img/default-cover.55254b66.png" alt="" class="header-img" data-v-996dafb6><!----><div id="content" class="content" data-v-996dafb6><p>In the first part, we explored how raw royalty files are processed and matched with users from the database who are due for payment. In this part, we focus on the next stage: batching the processed records and displaying aggregated results to users with advanced filtering capabilities. Scale continues to be a major challenge, with the customer already managing over 20 billion records in their database and growing. We’ll dive into the specific challenges we faced, one at a time.</p>
<h2 id="challenges-with-bulk-csv-imports-and-idempotency"><a href="#challenges-with-bulk-csv-imports-and-idempotency" aria-hidden="true"><span class="icon icon-link"></span></a>Challenges with Bulk CSV Imports and Idempotency</h2>
<p>In some cases, the CSV files we received from larger DSPs were massive, going up to 500 million records. Since we needed to group data by users to process payments, streaming and grouping in memory wasn’t practical. To ensure idempotency and avoid partial processing issues, we decided the best approach was to load the data into a database first and then perform the grouping there.</p>
<p>We were using MariaDB as our transactional database, so we chose <code class="language-inline-text">LOAD DATA INFILE</code> to import the CSVs. It’s the fastest native way to load large volumes directly into a table.</p>
<p>However, two major challenges came up:</p>
<ol>
<li>The import itself was extremely slow — roughly 4 hours for 250 million records.</li>
<li>To maintain idempotency and ensure no duplicate processing, we added unique constraints on the table. But if the worker importing the data crashed (which could happen for a number of reasons), the process had to be restarted from scratch, taking the full 4 hours again.</li>
</ol>
<p>In one particular run, we encountered a strange edge case: a crash caused a few records to be partially written with a <code class="language-inline-text">NULL</code> value in a column that was supposed to be unique. When the import was retried, the uniqueness check failed, and four extra rows were accidentally inserted. While we caught the mismatch manually and no actual dollar loss occurred, theoretically it would have been about an $11 discrepancy.</p>
<p>We weren't able to fully pinpoint why this happened — especially since <code class="language-inline-text">LOAD DATA INFILE</code> is supposed to respect transactions and we had unique constraints defined. It’s possible the server crashed so abruptly that it left the database in a slightly inconsistent state.</p>
<p>If anyone else has faced similar issues while working with <code class="language-inline-text">LOAD DATA INFILE</code> at this kind of scale, would love to hear your experiences.</p>
<h2 id="moving-to-clickhouse-for-faster-bulk-loads"><a href="#moving-to-clickhouse-for-faster-bulk-loads" aria-hidden="true"><span class="icon icon-link"></span></a>Moving to ClickHouse for Faster Bulk Loads</h2>
<p>After struggling with massive CSV imports in MariaDB, we realized we were hitting the limits of what it could handle. Even though we were inserting into a temporary table, the performance just wasn’t where we needed it to be. It was taking close to 4 hours to load 250 million records and any crash meant starting all over again.</p>
<p>At that point, it was clear: MariaDB wasn’t built for this kind of bulk load at scale.</p>
<p>That’s when we decided to try <a href="https://clickhouse.com/"><strong>ClickHouse</strong></a>, an OLAP database that’s much better suited for heavy read/write operations on large datasets. The difference was immediate. The same 250 million records that took 4 hours in MariaDB were loaded into ClickHouse in about <strong>10 minutes</strong>.</p>
<h2 id="clickhouses-native-s3-integration"><a href="#clickhouses-native-s3-integration" aria-hidden="true"><span class="icon icon-link"></span></a>ClickHouse’s Native S3 Integration</h2>
<p>ClickHouse also opened up new possibilities for us.
It has native <strong>S3 integration</strong>, which meant we could directly load data from S3 into ClickHouse tables and export data back into CSV format straight from the database without routing it through the application.
Since pulling large datasets into the app was slow, being able to generate CSVs directly from ClickHouse saved a lot of time on post-processing as well.</p>
<p>In hindsight, shifting to ClickHouse not only solved our immediate loading problem but also gave us a much better foundation for scaling the system as the data volume kept growing.</p>
<h2 id="balancing-olap-and-oltp-the-hybrid-approach"><a href="#balancing-olap-and-oltp-the-hybrid-approach" aria-hidden="true"><span class="icon icon-link"></span></a>Balancing OLAP and OLTP: The Hybrid approach</h2>
<p>While moving to ClickHouse massively improved our insert speeds, it quickly became clear that we couldn’t get away from needing a <strong>transactional (ACID-compliant) database</strong>.
We still had to perform critical operations like royalty splits, deducting advances, and handling expenses, all of which required reliable database transactions. However, performing transactional operations inside an analytical database like ClickHouse was not ideal.</p>
<p>Since ClickHouse is exceptionally good at <strong>aggregation</strong> and <strong>S3 integrations</strong>, we adjusted our workflow:</p>
<p>Instead of trying to load a massive, 40-column CSV into MariaDB, we first loaded the entire file into ClickHouse. There, we <strong>aggregated</strong> the data down to <strong>person-level, album-level, and song-level summaries</strong>, depending on what was needed for further processing.</p>
<p>Once aggregated, we pushed much <strong>smaller, minimal</strong> datasets back into MariaDB, just the columns that were actually required for transactional operations.
Loading these smaller, tightly-focused files into MariaDB using <code class="language-inline-text">LOAD DATA INFILE</code> was <strong>almost instant</strong>, completely removing the painful multi-hour imports we were dealing with earlier.</p>
<p>In the end, this hybrid approach gave us the best of both worlds:</p>
<ul>
<li><strong>ClickHouse</strong> for fast ingestion, aggregation, and S3 file management.</li>
<li><strong>MariaDB</strong> for ACID-compliant transactional workflows.
This setup let us scale processing without compromising on correctness or speed and was exactly what we needed for handling royalties at the scale we were targeting.</li>
</ul>
<h2 id="speeding-up-user-experience-with-clickhouse-for-aggregated-views"><a href="#speeding-up-user-experience-with-clickhouse-for-aggregated-views" aria-hidden="true"><span class="icon icon-link"></span></a>Speeding Up User Experience with ClickHouse for Aggregated Views</h2>
<p>Once all the transactional processing was done, the next challenge was <strong>making the data easily accessible to users</strong> and showing them how much they had earned, and allowing them to apply advanced filters and aggregations to slice and dice the data.</p>
<p>Initially, we were using a <strong>read-only MariaDB replica</strong>, storing pre-summarized data in special tables to support the UI.
However, we started hitting bottlenecks once the data crossed about <strong>4 billion records</strong>.
The main issue was that the <strong>same table</strong> was being used for both <strong>inserts</strong> and <strong>reads</strong>, leading to significant contention and performance degradation.</p>
<p>To solve this, we shifted the final storage of processed data to <strong>ClickHouse</strong> instead of MariaDB in a denormalised way so no join queries were done when UI requests for the data.
Since ClickHouse is built for analytical queries, aggregates and filtered reads became <strong>lightning fast</strong>, especially when we properly used <strong>sorting keys</strong>.</p>
<h3 id="the-result"><a href="#the-result" aria-hidden="true"><span class="icon icon-link"></span></a>The result?</h3>
<p>The UI responsiveness improved dramatically, users who earlier saw endless loading icons were now able to see their earnings and apply filters almost instantly.</p>
<p>This change not only made the system far more scalable but also elevated the <strong>overall user experience</strong>, which is critical when dealing with financial data at scale.</p>
<p>— -</p>
<p>This wraps up our two-part series on how we addressed the challenges of processing royalties at massive scale — from handling raw ingestion and ensuring transactional integrity, to optimizing user-facing analytics using a hybrid database architecture.</p>
<p>Every system hits scaling limits in different ways, and there is no single solution that fits all. It’s about picking the right tools at the right stage of growth.</p>
<p>If you’re planning to scale your existing systems or build something new from the ground up, we’d love to connect.</p>
<p>At <strong>Tarka Labs</strong>, we focus on building high-performance solutions across Music Distribution, Royalty Processing, and Trend Analytics. Whether you are solving today’s challenges or planning for the future, we’re here to help you make it happen.</p>
</div><hr data-v-996dafb6><div class="inner-section" data-v-996dafb6><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/harman.9bd8c31a.jpg" alt="Harman Sohanpal" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Harman Sohanpal</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            Developer
          </p></div></div><p class="body-opensans-size-9" data-v-996dafb6>He is still thinking what to write about him</p><div class="social-links" data-v-996dafb6><!----><!----><!----></div></div><hr data-v-996dafb6><div class="related-articles" data-v-996dafb6><div class="flex-space-between" data-v-996dafb6><p class="heading-size-7" data-v-996dafb6>_related articles</p><a href="/blogs" class="heading-size-9 underline" data-v-996dafb6>View all</a></div><div class="flex-space-between blog-card-wrapper" data-v-996dafb6><a href="/blogs/inserting-millions-of-records-in-java" class="blog-card" data-v-996dafb6><img src="/assets/img/image-2.646b7a73.png" alt="Inserting Millions of Records in Java: Strategies and Benchmarks" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/web</p><h3 data-v-996dafb6>Inserting Millions of Records in Java: Strategies and Benchmarks</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Kesavan   11 min read
            </p></div></a><a href="/blogs/scaling-royalty-payout-p1" class="blog-card" data-v-996dafb6><img src="/assets/img/default-cover.55254b66.png" alt="" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/web</p><h3 data-v-996dafb6>Scaling Royalty Payouts in Music Distribution: Challenges and Solutions from the Frontlines (Part 1)</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Harman Sohanpal   6 min read
            </p></div></a></div></div><div class="lets-talk" data-v-188e6a71><div class="message heading-size-7" data-v-188e6a71>
    Let’s build digital solutions together.
  </div><div class="action-container" data-v-188e6a71><div class="action-button heading-size-5" data-v-188e6a71><div data-v-188e6a71>Get in touch</div><div class="arrow" data-v-188e6a71>-&gt;</div></div><img src="/assets/img/talk.71d1d2f3.svg" alt="Lenny Face" data-v-188e6a71></div></div></div></div><div data-v-996dafb6></div></div><div id="footer" class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="site-footer" data-v-0a037a4b data-v-b5a9baaa><ul class="main-nav footer" data-v-244aa462 data-v-0a037a4b><div class="primary fadeIn" data-v-244aa462><li data-v-244aa462><a href="/music-biz" data-v-244aa462>/MusicBiz</a></li><li data-v-244aa462><a href="/genai" data-v-244aa462>/GenAI</a></li><li data-v-244aa462><a href="https://solutions.tarkalabs.com/design/" target="_self" data-v-244aa462>/Design</a></li><li data-v-244aa462><a href="/develop" data-v-244aa462>/Develop</a></li><li data-v-244aa462><a href="/case-studies" data-v-244aa462>
        /Case_Studies
      </a></li><li data-v-244aa462><a href="/careers" data-v-244aa462>/Careers</a></li><li data-v-244aa462><a href="/about" data-v-244aa462>/About</a></li><li data-v-244aa462><a href="/contact" data-v-244aa462>/Contact</a></li></div></ul><div class="subnav" data-v-0a037a4b><ul class="sub body-jetbrains-size-11 footer fadeIn" data-v-3cc3824e data-v-0a037a4b><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul><div data-v-fae945d8 data-v-0a037a4b><a href="https://twitter.com/tarkalabs" target="_blank" rel="noopener" class="external" data-v-fae945d8>Twitter</a><a href="https://in.linkedin.com/company/tarka-labs" target="_blank" rel="noopener" class="external" data-v-fae945d8>LinkedIn</a></div><div class="sedin" data-v-0a037a4b><a href="https://sedintechnologies.com/" target="_blank" rel="noopener" class="external" data-v-0a037a4b>Tarka Labs is a division of Sedin Technologies</a></div></div></div></div><div data-v-996dafb6></div></div></div></div></div>
    <script src="/assets/js/app.0797a3da.js" defer></script><script src="/assets/js/page--src--templates--blog-vue.80bca3bd.js" defer></script><script data-vue-tag="ssr" src="https://unpkg.com/@lottiefiles/lottie-player@0.4.0/dist/lottie-player.js" data-body="true"></script>
  </body>
</html>
