<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>OpenText Magellan and AKS: An unofficial deployment guide · Tarka Labs - Tarka Labs</title><meta name="gridsome:hash" content="f433ad77b8b7359a06b85465332ad833bc750e27"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="viewport" content="width=device-width, initial-scale=1.0"><meta data-vue-tag="ssr" property="og:title" content="OpenText Magellan and AKS: An unofficial deployment guide · Tarka Labs"><meta data-vue-tag="ssr" property="og:description" content="OpenText Magellan and AKS: An unofficial deployment guide"><meta data-vue-tag="ssr" property="og:image" content="/assets/img/default-cover.55254b66.png"><meta data-vue-tag="ssr" property="og:image:height" content="627"><meta data-vue-tag="ssr" property="og:image:width" content="1200"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.92f6d0f06feb6aec5e019521ff224fd8.png"><link rel="preload" href="/assets/css/0.styles.7b6ce15b.css" as="style"><link rel="preload" href="/assets/js/app.85c9a121.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--blog-vue.80bca3bd.js" as="script"><link rel="stylesheet" href="/assets/css/0.styles.7b6ce15b.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
    <meta
      name="google-site-verification"
      content="j7cLUK-kxGEpMOY7valSkamH4kQe_l38yMMAXbpk19U"
    />
    <noscript>
      <div class="noscript-container">
        <a href="/" class="noscript-logo">Tarka <br />_Labs</a>
        <div class="noscript-text-container">
          <h1>Uh oh! Looks like <span>JavaScript</span> is disabled.</h1>
          <p>
            Bitman requires <span>JavaScript</span> to fuel his thirst to end
            bad UX and lazy design, which is necessary to give you the best
            viewing experience possible. Please enable it to continue to our
            website.
          </p>
        </div>
      </div>
    </noscript>
  </head>

  <body >
    <div><div id="app" data-server-rendered="true" data-v-b5a9baaa><div data-v-b5a9baaa><div id="banner-section" data-v-b5a9baaa><div class="banner" style="background:;display:none;" data-v-b5a9baaa><div class="layout" data-v-b5a9baaa><div data-v-b5a9baaa></div><div class="hero heading-size-5" style="color:#ffffff;" data-v-b5a9baaa></div><div data-v-b5a9baaa></div></div></div><div data-v-b5a9baaa></div></div><div class="sidebar" data-v-d6d2017e data-v-b5a9baaa><div class="nav" data-v-d6d2017e><div class="fixed" data-v-d6d2017e><a href="/" data-v-9b1a4c9c data-v-d6d2017e> TARKA<br data-v-9b1a4c9c>_LABS </a><div class="menu" data-v-50705736 data-v-d6d2017e><div class="control" style="stroke:black;" data-v-50705736><div class="spinner heading-size-9" data-v-02ea7230 data-v-50705736><span class="side-menu-symbol" data-v-02ea7230><span class="menu-symbol rotate180t90" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span><span class="menu-symbol rotate90t0" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span></span><span style="vertical-align: middle" data-v-02ea7230> menu </span></div><div class="active-page body-jetbrains-size-11 fade-in" data-v-128e5feb data-v-50705736>
  
</div></div><div class="items hidden" data-v-50705736><ul class="main-nav" data-v-04879724 data-v-50705736><div class="primary fadeOut sidebar" data-v-04879724><li data-v-04879724><a href="/genai" data-v-04879724>/GenAI</a></li><li data-v-04879724><a href="https://solutions.tarkalabs.com/design/" target="_self" data-v-04879724>/Design</a></li><li data-v-04879724><a href="/develop" data-v-04879724>/Develop</a></li><li data-v-04879724><a href="/case-studies" data-v-04879724>
        /Case_Studies
      </a></li><li data-v-04879724><a href="/careers" data-v-04879724>/Careers</a></li><li data-v-04879724><a href="/about" data-v-04879724>/About</a></li><li data-v-04879724><a href="/contact" data-v-04879724>/Contact</a></li></div></ul><ul class="sub body-jetbrains-size-11 fadeOut sidebar" data-v-3cc3824e data-v-50705736><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul></div></div><a href="/contact" class="heading-size-9" data-v-573e12d8 data-v-d6d2017e>
  Get in<br data-v-573e12d8>touch<span class="arrow" data-v-573e12d8>-&gt;</span></a></div></div><!----></div><div class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="blog-details-page" data-v-996dafb6><div class="inner-section" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>
        /devops - 11 min read
      </p><h1 class="title" data-v-996dafb6>OpenText Magellan and AKS: An unofficial deployment guide</h1><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/shamil.116f5579.png" alt="Shamil Siddique" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Shamil Siddique</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            Developer
          </p></div></div></div><img src="/assets/img/default-cover.55254b66.png" alt="OpenText Magellan and AKS: An unofficial deployment guide" class="header-img" data-v-996dafb6><div class="toc-wrapper" data-v-996dafb6><h2 class="heading-size-7" data-v-996dafb6>Table of contents</h2><div class="toc" data-v-996dafb6><a href="#content" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/01</p><p data-v-996dafb6>Intro</p></a><a href="#toc-section-1" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/02</p><p data-v-996dafb6>Pre-requisites</p></a><a href="#toc-section-2" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/03</p><p data-v-996dafb6>Step 1: Authenticate Azure CLI</p></a><a href="#toc-section-3" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/04</p><p data-v-996dafb6>Step 2: Set up Resource group</p></a><a href="#toc-section-4" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/05</p><p data-v-996dafb6>Step 3: Set up PostgreSQL service (Optional)</p></a><a href="#toc-section-5" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/06</p><p data-v-996dafb6>Step 4: Create the AKS Cluster</p></a><a href="#toc-section-6" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/07</p><p data-v-996dafb6>Step 5: Create an Azure Container Registry (ACR)</p></a><a href="#toc-section-7" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/08</p><p data-v-996dafb6>Step 6: Add images to ACR</p></a><a href="#toc-section-8" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/09</p><p data-v-996dafb6>Step 7: Create a Storage Class</p></a><a href="#toc-section-9" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/10</p><p data-v-996dafb6>Step 8: Create a namespace</p></a><a href="#toc-section-10" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/11</p><p data-v-996dafb6>Step 9: Create Persistent Volume Claim</p></a><a href="#toc-section-11" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/12</p><p data-v-996dafb6>Step 10: Create a static IP</p></a><a href="#toc-section-12" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/13</p><p data-v-996dafb6>Step 11: Deploy an Ingress Controller</p></a><a href="#toc-section-13" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/14</p><p data-v-996dafb6>Step 12: Update Helm Chart values</p></a><a href="#toc-section-14" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/15</p><p data-v-996dafb6>Step 13: Create a custom tier (Optional)</p></a><a href="#toc-section-15" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/16</p><p data-v-996dafb6>Step 14: Deploy!</p></a><a href="#toc-section-16" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/17</p><p data-v-996dafb6>Bonus steps</p></a><a href="#toc-section-17" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/18</p><p data-v-996dafb6>Conclusion</p></a></div></div><div id="content" class="content" data-v-996dafb6><p>A couple of days back, I got my first task for 2024 — to deploy a product called <a href="https://www.opentext.com/products/magellan-platform" target="_blank" rel="nofollow noopener noreferrer">OpenText Magellan</a> on an Azure cluster. I was provided with the official cloud deployment guide and user guide. It was my first time hearing the product name; but I don’t blame myself though. It is not something that I’d come across every day.</p>
<p>Anyway, I did what I usually do with when I’m jumping into something new. I looked into the product details, the pros and cons, articles and all those stuff. After I got a brief understanding of what it was, I jumped into the cloud deployment guide — specifically the sections involving the steps for Azure.</p>
<p>I then headed over to OpenText Support portal, searched for Magellan and downloaded the Helm chart for Magellan 23.4.0.1296. I’ve noted down everything I did for getting the product deployed, and this post will be the same, with a couple of redactions.</p>
<h1 id="toc-section-1"><a href="#pre-requisites" aria-hidden="true"><span class="icon icon-link"></span></a>Pre-requisites</h1>
<ol>
<li>A Microsoft Azure account with some credits (or a credit card)</li>
<li>Azure CLI</li>
<li>Kubectl</li>
<li>Helm</li>
<li>Docker</li>
<li>A domain address for the deployment</li>
</ol>
<blockquote>
<p><strong>Note</strong>: Magellan RELEASE notes mentions the exact versions of the above requirements. Do refer the RELEASE notes specific to your MTM version for best results :D</p>
</blockquote>
<h1 id="toc-section-2"><a href="#step-1-authenticate-azure-cli" aria-hidden="true"><span class="icon icon-link"></span></a>Step 1: Authenticate Azure CLI</h1>
<p>Run the following command and a new browser tab will open up. Login to Azure in the tab, and it’ll authenticate the Azure CLI.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az login</code></pre></div>
<h1 id="toc-section-3"><a href="#step-2-set-up-resource-group" aria-hidden="true"><span class="icon icon-link"></span></a>Step 2: Set up Resource group</h1>
<p>In this step, we’ll create a resource group, which will be used as a grouping for the resources availed for our Magellan deployment. We’ll name it as <strong>aks-magellan-res-grp</strong>.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az group create \
--name aks-magellan-res-grp \
--location eastus</code></pre></div>
<h1 id="toc-section-4"><a href="#step-3-set-up-postgresql-service-optional" aria-hidden="true"><span class="icon icon-link"></span></a>Step 3: Set up PostgreSQL service (Optional)</h1>
<p>Magellan supports using Postgres docker image as well, so this step is optional. In my case, I’ve skipped this step and chosen Postgres docker image. Nonetheless, these are the steps for setting up external PostgreSQL service as per the official guide:</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az postgres server create \
--resource-group aks-magellan-res-grp \
--name magellanpostgres \
--location eastus \
--admin-user admin \
--admin-password password \
--sku-name B_Gen5_2</code></pre></div>
<p>Here, the values can be changed, but the name of the resource group should match that of the resource group we created above.</p>
<p>For accessing the Postgres service from our local device, we should either have a static IP or a VPN that provides one. We’ll then create a firewall rule to allow our local device to communicate with the Postgres server.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az postgres server firewall-rule create \
--resource-group aks-magellan-res-grp \
--server magellanpostgres \
--name AllowMyIP \
--start-ip-address 192.168.1.1 \
--end-ip-address 192.168.1.1</code></pre></div>
<p>Here, the resource group should match the name of the resource group we created, and the server should match the name of the postgres server we created in the previous command. Name can be changed, and start IP address and end IP address should be the static IP address (provided by ISP or VPN).</p>
<p>We should verify the PostgreSQL configs.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az postgres server show \
--resource-group aks-magellan-res-grp \
--name magellanpostgres</code></pre></div>
<p>Like before, resource group should match and name should be the name of the postgres service we created earlier.</p>
<p>We can then verify the database SQL connection with the following comand (enter password when prompted):</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">psql \
--host=magellanpostgres.postgres.database.azure.com \
--port=5432 \
--username=admin@magellanpostgres \
--dbname=postgres</code></pre></div>
<p>Here, we can find the host address of the Postgres service when we go to the newly created Postgres service through the Azure Portal. The default port and DB is 5432 and postgres respectively. Username should be in the format username@host , where the host is the name of the Postgres service we created.</p>
<h1 id="toc-section-5"><a href="#step-4-create-the-aks-cluster" aria-hidden="true"><span class="icon icon-link"></span></a>Step 4: Create the AKS Cluster</h1>
<p>As per the guide, we’ll create an Azure Kubernetes Service (AKS) cluster with 2 or more nodes (specify node count and VM size depending on Magellan tier). This command might take a couple of minutes to create the cluster.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az aks create \
--name aks-magellan-cluster \
--resource-group aks-magellan-res-grp \
--node-count 2 \
--generate-ssh-keys</code></pre></div>
<p>In this command, we’re specifying node count as 2, but the Magellan tier that I deployed required 4 nodes to run. If requirements are high, the easiest way is to navigate to the nodepools for the cluster in Azure portal, and then enable autoscale for the nodepool (mine was minimum 2 and maximum 10 nodes). I also required the VM size <strong>B4ms</strong> for 4 vCPUs as per my spec, which I specified using node-vm-size key in the above command.</p>
<p>We should then run the following command to download the credentials for the cluster, and this also updates the kubectl config to access the cluster.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az aks get-credentials \
--name aks-magellan-cluster \
--resource-group aks-magellan-res-grp</code></pre></div>
<p>We can then verify that kubectl config is updated to access our cluster.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl get nodes</code></pre></div>
<p>The command above should get us a small table with the details of nodes in our newly created cluster.</p>
<h1 id="toc-section-6"><a href="#step-5-create-an-azure-container-registry-acr" aria-hidden="true"><span class="icon icon-link"></span></a>Step 5: Create an Azure Container Registry (ACR)</h1>
<p>We’ll be using docker images provided by OpenText, so we’ll start by creating an Azure Container Registry to store the images.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az acr create \
--resource-group aks-magellan-res-grp \
--name magellanacr \
--sku Basic</code></pre></div>
<p>Here, we are naming the ACR as <strong>magellanacr</strong>, but that can be any other name too. Resource group should match though.</p>
<p>We’ll then update our AKS cluster to attach the newly created ACR.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az aks update \
--name aks-magellan-cluster \
--resource-group aks-magellan-res-grp \
--attach-acr magellanacr</code></pre></div>
<p>We also need to allow a default admin credentials for our ACR. So, navigate to the ACR in Azure portal, and select <strong>Admin User</strong> under <strong>Access keys</strong> section.</p>
<h1 id="toc-section-7"><a href="#step-6-add-images-to-acr" aria-hidden="true"><span class="icon icon-link"></span></a>Step 6: Add images to ACR</h1>
<p>After setting up our ACR, we have to add the images from OpenText. We’ll begin by authenticating our Docker to access OpenText Container Registry.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker login registry.opentext.com</code></pre></div>
<p>When prompted, enter the username and password, which should be the same as the credentials used for accessing OpenText Support portal.</p>
<p>We’ll pull all the images mentioned in the guide to our local docker, though some of them might be omittable depending on one’s requirements.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker pull registry.opentext.com/mtm-admin:23.4.0.1296
docker pull registry.opentext.com/mtm-benchmarking:23.4.0.1296
docker pull registry.opentext.com/mtm-ecm-crawler:23.4.0.1296
docker pull registry.opentext.com/mtm-ecm-crawler-service:23.4.0.1296
docker pull registry.opentext.com/mtm-ecm-integration-services:23.4.0.1296
docker pull registry.opentext.com/mtm-engine:23.4.0.1296
docker pull registry.opentext.com/mtm-gateway:23.4.0.1296
docker pull registry.opentext.com/mtm-kafka:23.4.0.1296
docker pull registry.opentext.com/mtm-mongodb:23.4.0.1296
docker pull registry.opentext.com/mtm-pipeline:23.4.0.1296
docker pull registry.opentext.com/mtm-search-api:23.4.0.1296
docker pull registry.opentext.com/mtm-security:23.4.0.1296
docker pull registry.opentext.com/mtm-service-discovery-api:23.4.0.1296
docker pull registry.opentext.com/mtm-solr:23.4.0.1296
docker pull registry.opentext.com/mtm-web-crawler:23.4.0.1296
docker pull registry.opentext.com/mtm-zookeeper:23.4.0.1296
docker pull registry.opentext.com/mtm-engine-data:23.4.0.1296
docker pull registry.opentext.com/mtm-postgres:23.4.0.1296
docker pull registry.opentext.com/mtm-alpine:23.4.0.1296
docker pull registry.opentext.com/mtm-dynamic-crawler:23.4.0.1296
docker pull registry.opentext.com/mtm-external-model:23.4.0.1296</code></pre></div>
<p>Here, <strong>mtm</strong> stands for Magellan Text Mining. And if you are using a different version, update the tag (which is 23.4.0.1296 in this command).</p>
<p>After pulling the images to our local Docker, we’ll retag them for our Azure Container Registry.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker tag registry.opentext.com/mtm-admin:23.4.0.1296 magellanacr.azurecr.io/mtm-admin:23.4.0.1296
docker tag registry.opentext.com/mtm-benchmarking:23.4.0.1296 magellanacr.azurecr.io/mtm-benchmarking:23.4.0.1296
docker tag registry.opentext.com/mtm-ecm-crawler:23.4.0.1296 magellanacr.azurecr.io/mtm-ecm-crawler:23.4.0.1296
docker tag registry.opentext.com/mtm-ecm-crawler-service:23.4.0.1296 magellanacr.azurecr.io/mtm-ecm-crawler-service:23.4.0.1296
docker tag registry.opentext.com/mtm-ecm-integration-services:23.4.0.1296 magellanacr.azurecr.io/mtm-ecm-integration-services:23.4.0.1296
docker tag registry.opentext.com/mtm-engine:23.4.0.1296 magellanacr.azurecr.io/mtm-engine:23.4.0.1296
docker tag registry.opentext.com/mtm-gateway:23.4.0.1296 magellanacr.azurecr.io/mtm-gateway:23.4.0.1296
docker tag registry.opentext.com/mtm-kafka:23.4.0.1296 magellanacr.azurecr.io/mtm-kafka:23.4.0.1296
docker tag registry.opentext.com/mtm-mongodb:23.4.0.1296 magellanacr.azurecr.io/mtm-mongodb:23.4.0.1296
docker tag registry.opentext.com/mtm-pipeline:23.4.0.1296 magellanacr.azurecr.io/mtm-pipeline:23.4.0.1296
docker tag registry.opentext.com/mtm-search-api:23.4.0.1296 magellanacr.azurecr.io/mtm-search-api:23.4.0.1296
docker tag registry.opentext.com/mtm-security:23.4.0.1296 magellanacr.azurecr.io/mtm-security:23.4.0.1296
docker tag registry.opentext.com/mtm-service-discovery-api:23.4.0.1296 magellanacr.azurecr.io/mtm-service-discovery-api:23.4.0.1296
docker tag registry.opentext.com/mtm-solr:23.4.0.1296 magellanacr.azurecr.io/mtm-solr:23.4.0.1296
docker tag registry.opentext.com/mtm-web-crawler:23.4.0.1296 magellanacr.azurecr.io/mtm-web-crawler:23.4.0.1296
docker tag registry.opentext.com/mtm-zookeeper:23.4.0.1296 magellanacr.azurecr.io/mtm-zookeeper:23.4.0.1296
docker tag registry.opentext.com/mtm-engine-data:23.4.0.1296 magellanacr.azurecr.io/mtm-engine-data:23.4.0.1296
docker tag registry.opentext.com/mtm-postgres:23.4.0.1296 magellanacr.azurecr.io/mtm-postgres:23.4.0.1296
docker tag registry.opentext.com/mtm-alpine:23.4.0.1296 magellanacr.azurecr.io/mtm-alpine:23.4.0.1296
docker tag registry.opentext.com/mtm-dynamic-crawler:23.4.0.1296 magellanacr.azurecr.io/mtm-dynamic-crawler:23.4.0.1296
docker tag registry.opentext.com/mtm-external-model:23.4.0.1296 magellanacr.azurecr.io/mtm-external-model:23.4.0.1296</code></pre></div>
<p>You can omit the images that you omitted in the previous step. If your ACR name is different, you should replace <strong>magellanacr.azure.io</strong> with the URL for your ACR (which can be found in the Azure portal).</p>
<p>We’ll now authenticate our local Docker to our ACR, using the Azure CLI.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az acr login \
--name magellanacr</code></pre></div>
<p>Next step is to push the images that we had retagged in our previous step.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker push magellanacr.azurecr.io/mtm-admin:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-benchmarking:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-ecm-crawler:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-ecm-crawler-service:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-ecm-integration-services:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-engine:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-gateway:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-kafka:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-mongodb:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-pipeline:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-search-api:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-security:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-service-discovery-api:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-solr:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-web-crawler:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-zookeeper:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-engine-data:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-postgres:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-alpine:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-dynamic-crawler:23.4.0.1296
docker push magellanacr.azurecr.io/mtm-external-model:23.4.0.1296</code></pre></div>
<p>Like earlier, images that were not pulled can be omitted. And the <strong>magellanacr.azurecr.io</strong> part might need to be replaced depending on your ACR name.</p>
<blockquote>
<p><strong>Note</strong>: The Docker images might be quite large, so the pull and push commands might take a bit of time. If pull or push command fails midway, just re-run the same command — docker won’t duplicate the images that were successfully pushed/pulled.</p>
</blockquote>
<p>We can then verify that all the images are in our ACR with the following command, which lists the images in ACR.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az acr repository list \
--name magellanacr</code></pre></div>
<h1 id="toc-section-8"><a href="#step-7-create-a-storage-class" aria-hidden="true"><span class="icon icon-link"></span></a>Step 7: Create a Storage Class</h1>
<p>The helm chart already provides a YAML file to create a Storage Class, called <strong>mtm</strong>. Once you are in the root folder (parent of aws, azure, gcp and mtm folders), run the following command.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl apply -f azure/mtm-storage-class-azure.yaml</code></pre></div>
<p>We’ll then verify that the Storage Class is created.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl get sc mtm</code></pre></div>
<h1 id="toc-section-9"><a href="#step-8-create-a-namespace" aria-hidden="true"><span class="icon icon-link"></span></a>Step 8: Create a namespace</h1>
<p>We’ll create a namespace to use for our Magellan deployment using the following command.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl create namespace magellan-namespace</code></pre></div>
<p>Here, I’ve named the namespace as <strong>magellan-namespace</strong>. We can verify that it is created by running the following command, which should return the name of the namespace.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl config view --minify | grep "namespace: magellan-namespace"</code></pre></div>
<p>We’ll then set the new namespace as the current context.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl config set-context \
--current --namespace="magellan-namespace"</code></pre></div>
<h1 id="toc-section-10"><a href="#step-9-create-persistent-volume-claim" aria-hidden="true"><span class="icon icon-link"></span></a>Step 9: Create Persistent Volume Claim</h1>
<p>Firstly, we need to verify that our subscription to <strong>Microsoft.Storage</strong> is registered.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az provider list \
--query "[?namespace=='Microsoft.Storage']" \
--output table</code></pre></div>
<p>If the status of the response is <strong>NotRegistered</strong>, we’ll have to register for it manually using the following command.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az provider register \
--namespace Microsoft.Storage</code></pre></div>
<p>You can re-verify the subscription status after running the above command.</p>
<p>We’ll then apply the azure/mtm-pvc-azure-file.yaml file in our folder as per instructions mentioned in the guide.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl apply -f azure/mtm-pvc-azure-file.yaml</code></pre></div>
<p>Verify that the new PVC has been created by running the following command and checking that the status is <strong>Bound</strong>.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl get pvc mtm</code></pre></div>
<p>In my case, where I was using a PostgreSQL docker image instead of the service, I had to apply azure/mtm-pvc-azure-disk.yaml as well.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl apply -f azure/mtm-pvc-azure-disk.yaml</code></pre></div>
<p>If we check the status of this PVC (named <strong>mtm-azuredisk</strong>), it will be in <strong>Pending</strong> state. That is because this will only become bound when it is initially used by the deployment.</p>
<h1 id="toc-section-11"><a href="#step-10-create-a-static-ip" aria-hidden="true"><span class="icon icon-link"></span></a>Step 10: Create a static IP</h1>
<p>We’ll ask Azure to provision a static IP which we’ll later be connecting with our domain address.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az network public-ip create \
--name magellan-ip \
--resource-group aks-magellan-res-grp \
--allocation-method static \
--query publicIP.ipAddress \
--sku Standard \
-o tsv</code></pre></div>
<p>Here, we’ve named the IP as <strong>magellan-ip</strong>. The resource group should match as well.</p>
<p>Next, we should verify that our IP is present in the public IP list.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">az network public-ip list</code></pre></div>
<h1 id="toc-section-12"><a href="#step-11-deploy-an-ingress-controller" aria-hidden="true"><span class="icon icon-link"></span></a>Step 11: Deploy an Ingress Controller</h1>
<p>We’ll be using ingress-nginx controller, which is different from the default one that we can avail from Azure. So, we’ll add it to our helm repo list and update the list.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update</code></pre></div>
<p>We’ll then create our Ingress controller using the following command, which is a little different from the command provided in the official guide.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">helm install magellan-ingress-controller ingress-nginx/ingress-nginx \
--set rbac.create=true \
--set controller.service.loadBalancerIP=100.100.100.100 \
--set controller.config.proxy-body-size=1024m \
--set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path"=/healthz</code></pre></div>
<p>In the above command, replace 100.100.100.100 with the static IP that we created in step 10 above.</p>
<p>Also, notice the <strong>controller.service.annotations</strong> section — this is not in the guide. This part was added after going through a lot of debugging sessions. Apparently, Azure expects the health probe path to be /healthz (reference: <a href="https://github.com/Azure/AKS/issues/3210" target="_blank" rel="nofollow noopener noreferrer">https://github.com/Azure/AKS/issues/3210</a>).</p>
<h1 id="toc-section-13"><a href="#step-12-update-helm-chart-values" aria-hidden="true"><span class="icon icon-link"></span></a>Step 12: Update Helm Chart values</h1>
<p>Before deployment, we’ll update the Helm chart <strong>values.yaml</strong> file as mentioned in the guide (with occasional explanations given below):</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubernetes.cluster.provider: "azure"
kubernetes.cluster.domain: "my-domain-address.com"
kubernetes.cluster.storageClassName: "mtm"</code></pre></div>
<p>Here, domain address should be replaced with the domain address provisioned for the deployment. Also, update the DNS record to point to the static IP that we created for the deployment (which I earlier named as <strong>magellan-ip</strong> in step 10).</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker.registry: "magellanacr.azurecr.io”</code></pre></div>
<p>I am using the PostgreSQL docker image, so I filled the Postgres-related stuff in my values.yaml file as follows (Refer the guide if you’re using Azure Postgres service).</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">postgresql.use_docker_image: true
postgresql.pvc_name: "mtm-azuredisk"
postgresql.host: "mtm-postgres"
postgresql.port: 5432
postgresql.admin_database: "postgres"

credentials.postgresql.admin_user: "admin"
credentials.postgresql.admin_password: "YWRtaW4="</code></pre></div>
<p>Here, the admin_password given is the base64 encoded version of the string <strong>admin</strong>, which is the default password. All the passwords in the file are instructed to be base64 encoded versions as per the guide.</p>
<p>I’ve also opted to not use HTTPS here, but it can be configured by following the guide. So, we’ll update the following values.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">gateway.ssl.enabled: false
gateway.ssl.custom_certificate: false

credentials.gateway.ssl.key_store_password: ""
credentials.gateway.ssl.key_manager_password: ""</code></pre></div>
<p>Then, we have a few more values as mentioned in the guide.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">engine.replicas: 1
engine.replica_size: “10Gi”

solr.replicas: 1
solr.replica_size: “10Gi”
solr.num_shards: 1
solr.replication_factor: 1
solr.sc_name: "mtm"

zookeeper.replicas: 1
zookeeper.replica_size: "1Gi"
zookeeper.sc_name: "mtm"

kafka.replicas: 1
kafka.replica_size: "10Gi"
kafka.sc_name: "mtm"

mongodb.replica_size: "10Gi"
mongodb.sc_name: "mtm"</code></pre></div>
<h1 id="toc-section-14"><a href="#step-13-create-a-custom-tier-optional" aria-hidden="true"><span class="icon icon-link"></span></a>Step 13: Create a custom tier (Optional)</h1>
<p>The tiers for Magellan Text Mining (MTM) deployment are specified in the files inside mtm/tiers folder. In my case, I opted to create a custom tier file and named it as mtm/tiers/mtm-custom.yaml</p>
<p>I set a few services to not install, using the install.: false value and specified the required resources for the rest of the services, similar to the content in mtm-engine.yaml tier file.
<h1 id="toc-section-15"><a href="#step-14-deploy" aria-hidden="true"><span class="icon icon-link"></span></a>Step 14: Deploy!</h1>
</p><p>The guide mentions specifying the tier file along with the helm install command. I used the custom tier file that I created in step 13, so my command was as follows:</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">helm install mtm-23.4.0.1296 ./mtm/ -f ./mtm/tiers/mtm-custom.yaml</code></pre></div>
<p>The command should deploy the product and render a brief note regarding which URLs to access.</p>
<h1 id="toc-section-16"><a href="#bonus-steps" aria-hidden="true"><span class="icon icon-link"></span></a>Bonus steps</h1>
<p>If you decide to use HTTPS, you need to SSH into the node where the gateway service component is deployed. There is no direct way for this — but you can look into <a href="https://learn.microsoft.com/en-us/azure/bastion/bastion-overview" target="_blank" rel="nofollow noopener noreferrer">Azure Bastions</a> or refer <a href="https://ystatit.medium.com/azure-ssh-into-aks-nodes-471c07ad91ef" target="_blank" rel="nofollow noopener noreferrer">this tutorial</a>. After accessing the node, refer the guide to create a Java keystore file and update the <strong>values.yaml</strong> file.</p>
<p>There are scenarios where you might want to upgrade the deployment. Redeployment after setting up SSL (as mentioned in above paragraph) would be a good example. In this case, we can run the following command:</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">helm upgrade -f ./tiers/mtm-custom.yaml mtm-23.4.0.1296 . \
--set=reconfigure={mtm-gateway,mtm-security}</code></pre></div>
<p>Here, I’ve asked to reconfigure <strong>mtm-gateway</strong> and <strong>mtm-security</strong> for SSL configuration. If you have other components to be reconfigured, mention that as well.</p>
<p>Also, in case some of your changes are not reflecting, the PVC might need to be recreated (I learned it the hard way!).</p>
<h1 id="toc-section-17"><a href="#conclusion" aria-hidden="true"><span class="icon icon-link"></span></a>Conclusion</h1>
<p>My deployment wasn’t as smooth as it might seem from the article. I had to debug a lot of stuff, and pairing up with other colleagues helped. Sometimes, you’ll learn new things, and at other times, fresh eyes help find stuff you overlooked.</p>
<p>An additional recommendation from me — use <a href="https://k8slens.dev/" target="_blank" rel="nofollow noopener noreferrer">Lens</a>, it helps.</p>
</div><hr data-v-996dafb6><div class="inner-section" data-v-996dafb6><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/shamil.116f5579.png" alt="Shamil Siddique" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Shamil Siddique</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            Developer
          </p></div></div><p class="body-opensans-size-9" data-v-996dafb6>He is still thinking what to write about him</p><div class="social-links" data-v-996dafb6><!----><!----><a href="https://medium.com/@shamilsdq" target="_blank" class="heading-size-9" data-v-996dafb6>
          Medium
        </a></div></div><hr data-v-996dafb6><div class="related-articles" data-v-996dafb6><div class="flex-space-between" data-v-996dafb6><p class="heading-size-7" data-v-996dafb6>_related articles</p><a href="/blogs" class="heading-size-9 underline" data-v-996dafb6>View all</a></div><div class="flex-space-between blog-card-wrapper" data-v-996dafb6><a href="/blogs/aws-ecs-monitoring-solution" class="blog-card" data-v-996dafb6><img src="/assets/img/cover.48fab8a3.gif" alt="The only in-depth AWS ECS monitoring solution you'll need" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/devops</p><h3 data-v-996dafb6>The only in-depth AWS ECS monitoring solution you'll need</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Madhava Reddy SV   6 min read
            </p></div></a><a href="/blogs/centralized-alert-routing-system-aws-lambda" class="blog-card" data-v-996dafb6><img src="/assets/img/cover.48fab8a3.gif" alt="Designing a centralized alert routing system using AWS Lambda" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/devops</p><h3 data-v-996dafb6>Designing a centralized alert routing system using AWS Lambda</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Madhava Reddy SV   4 min read
            </p></div></a></div></div><div class="lets-talk" data-v-188e6a71><div class="message heading-size-7" data-v-188e6a71>
    Let’s build digital solutions together.
  </div><div class="action-container" data-v-188e6a71><div class="action-button heading-size-5" data-v-188e6a71><div data-v-188e6a71>Get in touch</div><div class="arrow" data-v-188e6a71>-&gt;</div></div><img src="/assets/img/talk.71d1d2f3.svg" alt="Lenny Face" data-v-188e6a71></div></div></div></div><div data-v-996dafb6></div></div><div id="footer" class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="site-footer" data-v-0a037a4b data-v-b5a9baaa><ul class="main-nav footer" data-v-04879724 data-v-0a037a4b><div class="primary fadeIn" data-v-04879724><li data-v-04879724><a href="/genai" data-v-04879724>/GenAI</a></li><li data-v-04879724><a href="https://solutions.tarkalabs.com/design/" target="_self" data-v-04879724>/Design</a></li><li data-v-04879724><a href="/develop" data-v-04879724>/Develop</a></li><li data-v-04879724><a href="/case-studies" data-v-04879724>
        /Case_Studies
      </a></li><li data-v-04879724><a href="/careers" data-v-04879724>/Careers</a></li><li data-v-04879724><a href="/about" data-v-04879724>/About</a></li><li data-v-04879724><a href="/contact" data-v-04879724>/Contact</a></li></div></ul><div class="subnav" data-v-0a037a4b><ul class="sub body-jetbrains-size-11 footer fadeIn" data-v-3cc3824e data-v-0a037a4b><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul><div data-v-fae945d8 data-v-0a037a4b><a href="https://twitter.com/tarkalabs" target="_blank" rel="noopener" class="external" data-v-fae945d8>Twitter</a><a href="https://in.linkedin.com/company/tarka-labs" target="_blank" rel="noopener" class="external" data-v-fae945d8>LinkedIn</a></div><div class="sedin" data-v-0a037a4b><a href="https://sedintechnologies.com/" target="_blank" rel="noopener" class="external" data-v-0a037a4b>Tarka Labs is a division of Sedin Technologies</a></div></div></div></div><div data-v-996dafb6></div></div></div></div></div>
    <script src="/assets/js/app.85c9a121.js" defer></script><script src="/assets/js/page--src--templates--blog-vue.80bca3bd.js" defer></script><script data-vue-tag="ssr" src="https://unpkg.com/@lottiefiles/lottie-player@0.4.0/dist/lottie-player.js" data-body="true"></script>
  </body>
</html>
