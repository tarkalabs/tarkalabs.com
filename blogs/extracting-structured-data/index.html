<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Extracting Structured Data from PDFs with Claude Sonnet and Amazon Bedrock · Tarka Labs - Tarka Labs</title><meta name="gridsome:hash" content="2c524a34610b4969d5c94d7216ed04c1e31bedf3"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="viewport" content="width=device-width, initial-scale=1.0"><meta data-vue-tag="ssr" property="og:title" content="Extracting Structured Data from PDFs with Claude Sonnet and Amazon Bedrock · Tarka Labs"><meta data-vue-tag="ssr" property="og:description" content="Extracting Structured Data from PDFs with Claude Sonnet and Amazon Bedrock"><meta data-vue-tag="ssr" property="og:image" content="/assets/img/default-cover.55254b66.png"><meta data-vue-tag="ssr" property="og:image:height" content="627"><meta data-vue-tag="ssr" property="og:image:width" content="1200"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.92f6d0f06feb6aec5e019521ff224fd8.png"><link rel="preload" href="/assets/css/0.styles.14fdcb10.css" as="style"><link rel="preload" href="/assets/js/app.d41bc224.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--blog-vue.ecffc636.js" as="script"><link rel="stylesheet" href="/assets/css/0.styles.14fdcb10.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
    <meta
      name="google-site-verification"
      content="j7cLUK-kxGEpMOY7valSkamH4kQe_l38yMMAXbpk19U"
    />
    <noscript>
      <div class="noscript-container">
        <a href="/" class="noscript-logo">Tarka <br />_Labs</a>
        <div class="noscript-text-container">
          <h1>Uh oh! Looks like <span>JavaScript</span> is disabled.</h1>
          <p>
            Bitman requires <span>JavaScript</span> to fuel his thirst to end
            bad UX and lazy design, which is necessary to give you the best
            viewing experience possible. Please enable it to continue to our
            website.
          </p>
        </div>
      </div>
    </noscript>
  </head>

  <body >
    <div><div id="app" data-server-rendered="true" data-v-b5a9baaa><div data-v-b5a9baaa><div id="banner-section" data-v-b5a9baaa><div class="banner" style="background:;display:none;" data-v-b5a9baaa><div class="layout" data-v-b5a9baaa><div data-v-b5a9baaa></div><div class="hero heading-size-5" style="color:#ffffff;" data-v-b5a9baaa></div><div data-v-b5a9baaa></div></div></div><div data-v-b5a9baaa></div></div><div class="sidebar" data-v-d6d2017e data-v-b5a9baaa><div class="nav" data-v-d6d2017e><div class="fixed" data-v-d6d2017e><a href="/" data-v-9b1a4c9c data-v-d6d2017e> TARKA<br data-v-9b1a4c9c>_LABS </a><div class="menu" data-v-50705736 data-v-d6d2017e><div class="control" style="stroke:black;" data-v-50705736><div class="spinner heading-size-9" data-v-48940e1e data-v-50705736><span class="side-menu-symbol" data-v-48940e1e><span class="menu-symbol rotate180t90" data-v-48940e1e><svg height="10" width="10" data-v-48940e1e><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-48940e1e></line></svg></span><span class="menu-symbol rotate90t0" data-v-48940e1e><svg height="10" width="10" data-v-48940e1e><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-48940e1e></line></svg></span></span><span class="Spinner-text" data-v-48940e1e> menu </span></div><div class="active-page body-jetbrains-size-11 fade-in" data-v-4767b8ae data-v-50705736>
  
</div></div><div class="items hidden" data-v-50705736><ul class="main-nav" data-v-20ea19cd data-v-50705736><div class="primary fadeOut sidebar" data-v-20ea19cd><li data-v-20ea19cd><a href="https://design.tarkalabs.com/" target="_self" data-v-20ea19cd>/Design</a></li><li data-v-20ea19cd><a href="/develop" data-v-20ea19cd>/Develop</a></li><li data-v-20ea19cd><a href="/projects" data-v-20ea19cd>/Case_Studies</a></li><li data-v-20ea19cd><a href="/careers" data-v-20ea19cd>/Careers</a></li><li data-v-20ea19cd><a href="/about" data-v-20ea19cd>/About</a></li><li data-v-20ea19cd><a href="/contact" data-v-20ea19cd>/Contact</a></li></div></ul><ul class="sub body-jetbrains-size-11 fadeOut sidebar" data-v-3cc3824e data-v-50705736><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul></div></div><a href="/contact" class="heading-size-9" data-v-573e12d8 data-v-d6d2017e>
  Get in<br data-v-573e12d8>touch<span class="arrow" data-v-573e12d8>-&gt;</span></a></div></div><!----></div><div class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="blog-details-page" data-v-996dafb6><div class="inner-section" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>
        /ai - 7 min read
      </p><h1 class="title" data-v-996dafb6>Extracting Structured Data from PDFs with Claude Sonnet and Amazon Bedrock</h1><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/k7.d295c558.png" alt="Kesavan" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Kesavan</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            Developer
          </p></div></div></div><img src="/assets/img/default-cover.55254b66.png" alt="Extracting Structured Data from PDFs with Claude Sonnet and Amazon Bedrock" class="header-img" data-v-996dafb6><div class="toc-wrapper" data-v-996dafb6><h2 class="heading-size-7" data-v-996dafb6>Table of contents</h2><div class="toc" data-v-996dafb6><a href="#content" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/01</p><p data-v-996dafb6>Intro</p></a><a href="#toc-section-1" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/02</p><p data-v-996dafb6>Problem Statement</p></a><a href="#toc-section-2" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/03</p><p data-v-996dafb6>Solution Overview</p></a><a href="#toc-section-3" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/04</p><p data-v-996dafb6>Claude request structure</p></a><a href="#toc-section-4" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/05</p><p data-v-996dafb6>Amazon bedrock setup</p></a><a href="#toc-section-5" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/06</p><p data-v-996dafb6>File Reader</p></a><a href="#toc-section-6" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/07</p><p data-v-996dafb6>Split PDF into images</p></a><a href="#toc-section-7" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/08</p><p data-v-996dafb6>Building the Bedrock Request Body</p></a><a href="#toc-section-8" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/09</p><p data-v-996dafb6>Putting It All Together</p></a><a href="#toc-section-9" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/10</p><p data-v-996dafb6>Conclusion</p></a></div></div><div id="content" class="content" data-v-996dafb6><p>Extracting structured data from PDFs is a common challenge across various industries. Whether you’re dealing with invoices, KYB documents, contracts, or reports, automating this process can significantly save time and reduce errors.
In this blog, I’ll guide you through extracting JSON data from a PDF file using Claude Sonnet, a Generative AI model, and Amazon Bedrock. We’ll break down the steps and provide sample code to run on your local machine, making it easy for you to replicate this solution.</p>
<h1 id="toc-section-1"><a href="#problem-statement" aria-hidden="true"><span class="icon icon-link"></span></a>Problem Statement</h1>
<p>We have a sample invoice PDF that contains two pages, including details like the invoice number, total amount, and other key information.</p>
<figure><img src="/blog/extracting-structured-data/invoice.png" alt="Images from https://resources.docmosis.com/example-templates/generate-multi-page-invoice-from-template"><figcaption>Images from https://resources.docmosis.com/example-templates/generate-multi-page-invoice-from-template</figcaption></figure>
<p>We aim to extract specific fields from this PDF and output them in JSON format, the JSON will have following fields:</p>
<ul>
<li><code class="language-inline-text">total_amount</code> (numeric)</li>
<li><code class="language-inline-text">company_name</code> (string)</li>
<li><code class="language-inline-text">currency_name</code> (string)</li>
<li><code class="language-inline-text">invoice_no</code> (string)</li>
<li><code class="language-inline-text">invoice_date</code> (string)</li>
</ul>
<h1 id="toc-section-2"><a href="#solution-overview" aria-hidden="true"><span class="icon icon-link"></span></a>Solution Overview</h1>
<p>While many extraction tools are available to solve this, A Generative AI (Gen AI) model offers the most straightforward programmatic solution for this task. The way Gen AI models work is, it accepts an input images and along with the user Prompt(contains the info of what the user want) and it returns the response.</p>
<p>Here’s a brief overview of the tools we’ll use:</p>
<ul>
<li><strong>Claude Sonnet</strong>: A powerful Generative AI model that can understand and process both text and images.</li>
<li><strong>Amazon Bedrock</strong>: A managed service that provides a single API for calling foundational models from various providers, including Anthropic Claude Sonnet. (you can find the set of models managed by Amazon Bedrock <a href="https://docs.aws.amazon.com/bedrock/latest/userguide/model-ids.html" target="_blank" rel="nofollow noopener noreferrer">here</a>)</li>
</ul>
<p>We’ll use the Claude Sonnet 3.5 model to extract structured data from the PDF file. To interact with it, we’ll leverage Amazon Bedrock. We’ll employ Python libraries to make it all work.</p>
<figure><img src="/blog/extracting-structured-data/extracting-data.webp" alt="Extracting Data from PDF Workflow (Created using draw.io)"><figcaption>Extracting Data from PDF Workflow (Created using draw.io)</figcaption></figure>
<h1 id="toc-section-3"><a href="#claude-request-structure" aria-hidden="true"><span class="icon icon-link"></span></a>Claude request structure</h1>
<p>The following fields are required to trigger the Claude model:</p>
<ul>
<li><code class="language-inline-text">anthropic_version</code>: The Bedrock-specific version for the Anthropic model. In our case, we’ll use bedrock-2023–05–31.</li>
<li><code class="language-inline-text">max_tokens</code>: The maximum number of output tokens to generate.</li>
<li><code class="language-inline-text">messages</code>: Each message will contain details about the model prompt, including its <code class="language-inline-text">content</code> and <code class="language-inline-text">role</code>.<br>
The <code class="language-inline-text">content</code> field represents the input, which can be in the form of text or images. If the input is an image, it must be sent as a base64-encoded string. Base64 encoding is a straightforward method for sharing binary data over the internet. You can simply set the encoded string in the request body’s JSON field.
The <code class="language-inline-text">role</code> field can be either “user” or “assistant.” A message with a “user” role contains the user’s query. A message with an “assistant” role represents the Claude model’s response.</li>
</ul>
<div class="gridsome-highlight" data-language="json"><pre class="language-json"><code class="language-json"># Sample Claude model request body
<span class="token punctuation">{</span>
  <span class="token property">"anthropic_version"</span><span class="token operator">:</span> <span class="token string">"bedrock-2023-05-31"</span><span class="token punctuation">,</span>
  <span class="token property">"max_tokens"</span><span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
  <span class="token property">"messages"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
      <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"image"</span><span class="token punctuation">,</span>
          <span class="token property">"source"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"base64"</span><span class="token punctuation">,</span>
            <span class="token property">"media_type"</span><span class="token operator">:</span> <span class="token string">"image/jpeg"</span><span class="token punctuation">,</span>
            <span class="token property">"data"</span><span class="token operator">:</span> <span class="token string">"iVBORw..."</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
          <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"What's in these images?"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>To create the message request structure above, we first need to split the PDF pages into base64-encoded images.</p>
<h1 id="toc-section-4"><a href="#amazon-bedrock-setup" aria-hidden="true"><span class="icon icon-link"></span></a>Amazon bedrock setup</h1>
<p>First, we’ll create a Bedrock runtime using the boto3 Python library to interact with the Claude Sonnet model.</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_bedrock_runtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">any</span><span class="token punctuation">:</span>
  client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'bedrock-runtime'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> client</code></pre></div>
<ul>
<li>get_bedrock_runtime simply creates the Bedrock runtime.</li>
</ul>
<p>Assuming your current AWS session has access to Amazon Bedrock, if necessary, pass the credentials explicitly to the boto3.client method like this:</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python">client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'bedrock-runtime'</span><span class="token punctuation">,</span> aws_access_key_id<span class="token operator">=</span><span class="token string">'xxxxx'</span><span class="token punctuation">,</span>
                      aws_secret_access_key<span class="token operator">=</span><span class="token string">'xxxxx'</span><span class="token punctuation">)</span></code></pre></div>
<p>Now let’s use the Bedrock runtime to invoke Bedrock models:</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python">MODEL_ID <span class="token operator">=</span> <span class="token string">"anthropic.claude-3-5-sonnet-20240620-v1:0"</span>
<span class="token keyword">def</span> <span class="token function">run_multi_modal_prompt</span><span class="token punctuation">(</span>req_body<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">try</span><span class="token punctuation">:</span>
      bedrock_runtime <span class="token operator">=</span> get_bedrock_runtime<span class="token punctuation">(</span><span class="token punctuation">)</span>
      response <span class="token operator">=</span> bedrock_runtime<span class="token punctuation">.</span>invoke_model<span class="token punctuation">(</span>
          body<span class="token operator">=</span>req_body<span class="token punctuation">,</span> modelId<span class="token operator">=</span>MODEL_ID<span class="token punctuation">)</span>
      response_body <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> response_body
  <span class="token keyword">except</span> ClientError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'unable to create bedrock runtime'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token keyword">raise</span></code></pre></div>
<ul>
<li><code class="language-inline-text">run_multi_modal_prompt</code> will invoke the model which we will mention in the request body. <code class="language-inline-text">req_body</code> contains the user prompt details and other metadata required to call the Claude Sonnet model.</li>
<li>First, it will get the Bedrock client using <code class="language-inline-text">get_bedrock_runtime</code>, then it will invoke the model using the model ID <code class="language-inline-text">anthropic.claude-3-5-sonnet-20240620-v1:0</code>, which is the latest version of Claude Sonnet.</li>
<li>The <code class="language-inline-text">invoke_model</code> method will return a response, and we're simply extracting the response body and converting it to a JSON object. So, we're returning the result as a dictionary.</li>
</ul>
<h1 id="toc-section-5"><a href="#file-reader" aria-hidden="true"><span class="icon icon-link"></span></a>File Reader</h1>
<p>We can use the open function to read a file in binary mode. Here's a function to get the bytes of a file:</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_file_bytes</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
  <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
      file_bytes <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> file_bytes</code></pre></div>
<h1 id="toc-section-6"><a href="#split-pdf-into-images" aria-hidden="true"><span class="icon icon-link"></span></a>Split PDF into images</h1>
<p>Claude model supports three formats: JPEG, PNG, and WEBP. We will use PNG because it generally has higher quality compared to the other two formats.
We will use the <code class="language-inline-text">pdf2image</code> library to split the PDF file’s pages into PNG images. Then, we will convert these images into base64-encoded strings.</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">split_pdf_pages</span><span class="token punctuation">(</span>pdf_bytes<span class="token punctuation">:</span><span class="token builtin">bytes</span><span class="token punctuation">,</span> max_size<span class="token punctuation">:</span><span class="token builtin">tuple</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
  images <span class="token operator">=</span> convert_from_bytes<span class="token punctuation">(</span>pdf_file<span class="token operator">=</span>pdf_bytes<span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">'png'</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> img <span class="token keyword">in</span> images<span class="token punctuation">:</span>
      <span class="token comment"># resize if it exceeds the max size</span>
      <span class="token keyword">if</span> img<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> max_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> img<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">></span> max_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
          img<span class="token punctuation">.</span>thumbnail<span class="token punctuation">(</span>max_size<span class="token punctuation">,</span> Resampling<span class="token punctuation">.</span>LANCZOS<span class="token punctuation">)</span>
  res <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span>b64_encoded_str<span class="token punctuation">,</span> images<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res

<span class="token keyword">def</span> <span class="token function">b64_encoded_str</span><span class="token punctuation">(</span>img<span class="token punctuation">:</span> Image<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
  byte_io <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>
  img<span class="token punctuation">.</span>save<span class="token punctuation">(</span>fp<span class="token operator">=</span>byte_io<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'PNG'</span><span class="token punctuation">,</span> quality<span class="token operator">=</span><span class="token number">75</span><span class="token punctuation">,</span> optimize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
  <span class="token comment"># uncomment the below line, to visualize the image we are sending</span>
  <span class="token comment"># img.save(f'pdf2img_{str(time.time())}.png') &lt;-- saves the png file</span>
  <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>byte_io<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span></code></pre></div>
<ul>
<li>The <code class="language-inline-text">split_pdf_pages</code> function takes a PDF's byte content and an optional maximum size as input. It splits the PDF into PNG images using <code class="language-inline-text">convert_from_bytes</code>, resizes images exceeding the maximum size to prevent excessive data, and converts each image to a base64-encoded string using <code class="language-inline-text">map</code> and <code class="language-inline-text">b64_encoded_str</code>. The function returns a list of base64-encoded strings representing the images</li>
<li>The <code class="language-inline-text">b64_encoded_str</code> function takes a Pillow Image object as input. It creates an in-memory byte stream, saves the image to the byte stream in PNG format with quality and optimization settings, and optionally saves the image to a file for visualization.</li>
</ul>
<h1 id="toc-section-7"><a href="#building-the-bedrock-request-body" aria-hidden="true"><span class="icon icon-link"></span></a>Building the Bedrock Request Body</h1>
<p>We will now use the previously defined methods to construct the Claude model request body.</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">build_claude_req_body</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
  file_bytes <span class="token operator">=</span> get_file_bytes<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
  base64_encoded_pngs <span class="token operator">=</span> split_pdf_pages<span class="token punctuation">(</span>file_bytes<span class="token punctuation">)</span>

  messages <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
      <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token operator">*</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"image"</span><span class="token punctuation">,</span>
              <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                 <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"base64"</span><span class="token punctuation">,</span>
                 <span class="token string">"media_type"</span><span class="token punctuation">:</span> <span class="token string">"image/png"</span><span class="token punctuation">,</span>
                 <span class="token string">"data"</span><span class="token punctuation">:</span> base64_encoded_png
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">for</span> base64_encoded_png <span class="token keyword">in</span> base64_encoded_pngs
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
          <span class="token string">"text"</span><span class="token punctuation">:</span> USER_PROMPT
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>

  req_body <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"anthropic_version"</span><span class="token punctuation">:</span> BEDROCK_ANTHROPIC_VERSION<span class="token punctuation">,</span>
    <span class="token string">"messages"</span><span class="token punctuation">:</span> messages<span class="token punctuation">,</span>
    <span class="token string">"system"</span><span class="token punctuation">:</span> SYSTEM_ROLE<span class="token punctuation">,</span>
    <span class="token string">'max_tokens'</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> req_body</code></pre></div>
<ul>
<li>The <code class="language-inline-text">build_claude_req_body</code> function accepts the input PDF file path and returns the request body that will be used to trigger the Amazon Bedrock runtime. This function first reads the file bytes using <code class="language-inline-text">get_file_bytes</code> and then converts the PDF bytes data to a list of base64-encoded strings using <code class="language-inline-text">split_pdf_pages</code>. It then creates a list of messages, builds the request body, and finally returns it.</li>
</ul>
<p>Let’s examine the USER_PROMPT and SYSTEM_ROLE used in the request body:</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python">USER_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
  Find the following fields and put it in JSON and don't return any thing else

  total_amount: numeric,
  company_name: str,
  currency_name: str,
  invoice_no: str,
  invoice_date: str
'''</span>
SYSTEM_ROLE <span class="token operator">=</span> <span class="token string">'You are an Expense Bill Analyst'</span></code></pre></div>
<ul>
<li><code class="language-inline-text">SYSTEM_ROLE</code> is primarily used to establish a domain-specific role. While it’s not mandatory, it can be helpful if you want your Model to become a specialized expert in a particular domain rather than a general assistant.</li>
<li>In <code class="language-inline-text">USER_PROMPT</code>, we are simply specifying the field names that we need to extract, and Claude Sonnet is intelligent enough to understand each field on its own. We are also explicitly stating that only the JSON output should be returned, excluding any additional text.
We have tested this with <strong>Sonnet 3.5</strong> version, and it has consistently produced only the JSON output. If the model were to return any fillers in the completion, such as "Here is the JSON output" or "total amount is xxxxx and we found it in the second image," you could prefill the prompt with an assistant role as mentioned <a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/prefill-claudes-response#example-structured-data-extraction-without-prefilling" target="_blank" rel="nofollow noopener noreferrer">here</a>.</li>
</ul>
<h1 id="toc-section-8"><a href="#putting-it-all-together" aria-hidden="true"><span class="icon icon-link"></span></a>Putting It All Together</h1>
<p>Let’s combine everything into a single method that accepts the file path and returns only the JSON object as a result.</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">extract_data</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
      body <span class="token operator">=</span> build_claude_req_body<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
      response <span class="token operator">=</span> run_multi_modal_prompt<span class="token punctuation">(</span>req_body<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Model response'</span><span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
      d <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> d
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'something went wrong'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></div>
<ul>
<li>The <code class="language-inline-text">extract_data</code> function accepts the file path, builds the Claude request body using <code class="language-inline-text">build_claude_req_body</code>, triggers the <code class="language-inline-text">run_multi_modal_prompt</code>, processes the response, and returns only the message content as a JSON object.</li>
</ul>
<p>An example of an Amazon Bedrock response looks like the following:</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token punctuation">{</span>
  <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"msg_bdrk_01Rq6zsWD34B1m5vyvxuQERX"</span><span class="token punctuation">,</span>
  <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"message"</span><span class="token punctuation">,</span>
  <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span>
  <span class="token string">"model"</span><span class="token punctuation">:</span> <span class="token string">"claude-3-5-sonnet-20240620"</span><span class="token punctuation">,</span>
  <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
      <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"&lt;Claude model generated text...>"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"stop_reason"</span><span class="token punctuation">:</span> <span class="token string">"end_turn"</span><span class="token punctuation">,</span>
  <span class="token string">"stop_sequence"</span><span class="token punctuation">:</span> null<span class="token punctuation">,</span>
  <span class="token string">"usage"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">"input_tokens"</span><span class="token punctuation">:</span> <span class="token number">2219</span><span class="token punctuation">,</span> <span class="token string">"output_tokens"</span><span class="token punctuation">:</span> <span class="token number">70</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We can find the assistant-generated text in the <code class="language-inline-text">response['content'][0]['text']</code> field. To understand more about the response fields, refer <a href="https://docs.aws.amazon.com/bedrock/latest/userguide/model-parameters-anthropic-claude-messages.html#model-parameters-anthropic-claude-messages-request-response" target="_blank" rel="nofollow noopener noreferrer">here</a></p>
<p>Here’s how you can use <code class="language-inline-text">extract_data</code> function, just pass the input file path:</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python">result <span class="token operator">=</span> extract_data<span class="token punctuation">(</span>invoice_pdf_file_path<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span></code></pre></div>
<p>The printed result will look like this:</p>
<div class="gridsome-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token punctuation">{</span>
  <span class="token string">'total_amount'</span><span class="token punctuation">:</span> <span class="token number">5715.0</span><span class="token punctuation">,</span>
  <span class="token string">'company_name'</span><span class="token punctuation">:</span> <span class="token string">'META LEGAL &amp; FINANCE'</span><span class="token punctuation">,</span>
  <span class="token string">'currency_name'</span><span class="token punctuation">:</span> <span class="token string">'USD'</span><span class="token punctuation">,</span>
  <span class="token string">'invoice_no'</span><span class="token punctuation">:</span> <span class="token string">'00000135'</span><span class="token punctuation">,</span>
  <span class="token string">'invoice_date'</span><span class="token punctuation">:</span> <span class="token string">'12 March 2024'</span>
<span class="token punctuation">}</span></code></pre></div>
<h1 id="toc-section-9"><a href="#conclusion" aria-hidden="true"><span class="icon icon-link"></span></a>Conclusion</h1>
<p>We’ve successfully demonstrated a method for extracting structured data from PDF files using the Claude Sonnet model and Amazon Bedrock. This approach can be adapted for various types of documents, making it a versatile tool for automation. If you’re dealing with similar challenges, give this approach a try and see how it can streamline your workflow. The complete setup can be found here</p>
<p><em>That’s a wrap, Thanks for reading!</em></p>
<h2 id="reference"><a href="#reference" aria-hidden="true"><span class="icon icon-link"></span></a>Reference</h2>
<ul>
<li><a href="https://docs.anthropic.com/en/docs/about-claude/models" target="_blank" rel="nofollow noopener noreferrer">Claude models</a></li>
<li><a href="https://docs.anthropic.com/en/docs/build-with-claude/vision#calculate-image-costs" target="_blank" rel="nofollow noopener noreferrer">Vision models Pricing</a></li>
<li><a href="https://github.com/anthropics/anthropic-cookbook/blob/main/multimodal/best_practices_for_vision.ipynb" target="_blank" rel="nofollow noopener noreferrer">Anthropic Cookbook</a></li>
</ul>
</div><hr data-v-996dafb6><div class="inner-section" data-v-996dafb6><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/k7.d295c558.png" alt="Kesavan" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Kesavan</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            Developer
          </p></div></div><p class="body-opensans-size-9" data-v-996dafb6>He is still thinking what to write about him</p><div class="social-links" data-v-996dafb6><!----><!----><a href="https://medium.com/@itzk7" target="_blank" class="heading-size-9" data-v-996dafb6>
          Medium
        </a></div></div><hr data-v-996dafb6><div class="related-articles" data-v-996dafb6><div class="flex-space-between" data-v-996dafb6><p class="heading-size-7" data-v-996dafb6>_related articles</p><a href="/blogs" class="heading-size-9 underline" data-v-996dafb6>View all</a></div><div class="flex-space-between blog-card-wrapper" data-v-996dafb6><a href="/blogs/batch-transcription" class="blog-card" data-v-996dafb6><img src="/assets/img/batch-transcription.e03c0d91.webp" alt="Implementing Serverless Batch Transcription with AWS Step Functions and Azure AI Services" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/ai</p><h3 data-v-996dafb6>Implementing Serverless Batch Transcription with AWS Step Functions and Azure AI Services</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Kesavan   8 min read
            </p></div></a></div></div><div class="lets-talk" data-v-188e6a71><div class="message heading-size-7" data-v-188e6a71>
    Let’s build digital solutions together.
  </div><div class="action-container" data-v-188e6a71><div class="action-button heading-size-5" data-v-188e6a71><div data-v-188e6a71>Get in touch</div><div class="arrow" data-v-188e6a71>-&gt;</div></div><img src="/assets/img/talk.71d1d2f3.svg" alt="Lenny Face" data-v-188e6a71></div></div></div></div><div data-v-996dafb6></div></div><div id="footer" class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="site-footer" data-v-0a037a4b data-v-b5a9baaa><ul class="main-nav footer" data-v-20ea19cd data-v-0a037a4b><div class="primary fadeIn" data-v-20ea19cd><li data-v-20ea19cd><a href="https://design.tarkalabs.com/" target="_self" data-v-20ea19cd>/Design</a></li><li data-v-20ea19cd><a href="/develop" data-v-20ea19cd>/Develop</a></li><li data-v-20ea19cd><a href="/projects" data-v-20ea19cd>/Case_Studies</a></li><li data-v-20ea19cd><a href="/careers" data-v-20ea19cd>/Careers</a></li><li data-v-20ea19cd><a href="/about" data-v-20ea19cd>/About</a></li><li data-v-20ea19cd><a href="/contact" data-v-20ea19cd>/Contact</a></li></div></ul><div class="subnav" data-v-0a037a4b><ul class="sub body-jetbrains-size-11 footer fadeIn" data-v-3cc3824e data-v-0a037a4b><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul><div data-v-fae945d8 data-v-0a037a4b><a href="https://twitter.com/tarkalabs" target="_blank" rel="noopener" class="external" data-v-fae945d8>Twitter</a><a href="https://in.linkedin.com/company/tarka-labs" target="_blank" rel="noopener" class="external" data-v-fae945d8>LinkedIn</a></div><div class="sedin" data-v-0a037a4b><a href="https://sedintechnologies.com/" target="_blank" rel="noopener" class="external" data-v-0a037a4b>Tarka Labs is a division of Sedin Technologies</a></div></div></div></div><div data-v-996dafb6></div></div></div></div></div>
    <script src="/assets/js/app.d41bc224.js" defer></script><script src="/assets/js/page--src--templates--blog-vue.ecffc636.js" defer></script><script data-vue-tag="ssr" src="https://unpkg.com/@lottiefiles/lottie-player@0.4.0/dist/lottie-player.js" data-body="true"></script>
  </body>
</html>
