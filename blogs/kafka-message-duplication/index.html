<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Handling message duplication in Kafka · Tarka Labs - Tarka Labs</title><meta name="gridsome:hash" content="1649211d25fe75c28e001e17d54192a916c09cd4"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="viewport" content="width=device-width, initial-scale=1.0"><meta data-vue-tag="ssr" property="og:title" content="Handling message duplication in Kafka · Tarka Labs"><meta data-vue-tag="ssr" property="og:description" content="Handling message duplication in Kafka"><meta data-vue-tag="ssr" property="og:image" content="/assets/img/kafka-message-duplication.30a6cddc.webp"><meta data-vue-tag="ssr" property="og:image:height" content="627"><meta data-vue-tag="ssr" property="og:image:width" content="1200"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.92f6d0f06feb6aec5e019521ff224fd8.png"><link rel="preload" href="/assets/css/0.styles.d3380898.css" as="style"><link rel="preload" href="/assets/js/app.0e5d4a8b.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--blog-vue.2099f288.js" as="script"><link rel="stylesheet" href="/assets/css/0.styles.d3380898.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
    <meta
      name="google-site-verification"
      content="j7cLUK-kxGEpMOY7valSkamH4kQe_l38yMMAXbpk19U"
    />
    <noscript>
      <div class="noscript-container">
        <a href="/" class="noscript-logo">Tarka <br />_Labs</a>
        <div class="noscript-text-container">
          <h1>Uh oh! Looks like <span>JavaScript</span> is disabled.</h1>
          <p>
            Bitman requires <span>JavaScript</span> to fuel his thirst to end
            bad UX and lazy design, which is necessary to give you the best
            viewing experience possible. Please enable it to continue to our
            website.
          </p>
        </div>
      </div>
    </noscript>
  </head>

  <body >
    <div><div id="app" data-server-rendered="true" data-v-b5a9baaa><div data-v-b5a9baaa><div id="banner-section" data-v-b5a9baaa><div class="banner" style="background:;display:none;" data-v-b5a9baaa><div class="layout" data-v-b5a9baaa><div data-v-b5a9baaa></div><div class="hero heading-size-5" style="color:#ffffff;" data-v-b5a9baaa></div><div data-v-b5a9baaa></div></div></div><div data-v-b5a9baaa></div></div><div class="sidebar" data-v-d6d2017e data-v-b5a9baaa><div class="nav" data-v-d6d2017e><div class="fixed" data-v-d6d2017e><a href="/" data-v-9b1a4c9c data-v-d6d2017e> TARKA<br data-v-9b1a4c9c>_LABS </a><div class="menu" data-v-50705736 data-v-d6d2017e><div class="control" style="stroke:black;" data-v-50705736><div class="spinner heading-size-9" data-v-02ea7230 data-v-50705736><span class="side-menu-symbol" data-v-02ea7230><span class="menu-symbol rotate180t90" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span><span class="menu-symbol rotate90t0" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span></span><span style="vertical-align: middle" data-v-02ea7230> menu </span></div><div class="active-page body-jetbrains-size-11 fade-in" data-v-128e5feb data-v-50705736>
  
</div></div><div class="items hidden" data-v-50705736><ul class="main-nav" data-v-748716d7 data-v-50705736><div class="primary fadeOut sidebar" data-v-748716d7><li data-v-748716d7><a href="/genai" data-v-748716d7>/GenAI</a></li><li data-v-748716d7><a href="https://design.tarkalabs.com/" target="_self" data-v-748716d7>/Design</a></li><li data-v-748716d7><a href="/develop" data-v-748716d7>/Develop</a></li><li data-v-748716d7><a href="/case-studies" data-v-748716d7>
        /Case_Studies
      </a></li><li data-v-748716d7><a href="/careers" data-v-748716d7>/Careers</a></li><li data-v-748716d7><a href="/about" data-v-748716d7>/About</a></li><li data-v-748716d7><a href="/contact" data-v-748716d7>/Contact</a></li></div></ul><ul class="sub body-jetbrains-size-11 fadeOut sidebar" data-v-3cc3824e data-v-50705736><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul></div></div><a href="/contact" class="heading-size-9" data-v-573e12d8 data-v-d6d2017e>
  Get in<br data-v-573e12d8>touch<span class="arrow" data-v-573e12d8>-&gt;</span></a></div></div><!----></div><div class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="blog-details-page" data-v-996dafb6><div class="inner-section" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>
        /web - 5 min read
      </p><h1 class="title" data-v-996dafb6>Handling message duplication in Kafka</h1><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/vignesh.104602f3.png" alt="Vignesh Ravichandran" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Vignesh Ravichandran</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            Developer
          </p></div></div></div><img src="/assets/img/kafka-message-duplication.30a6cddc.webp" alt="Handling message duplication in Kafka" class="header-img" data-v-996dafb6><div class="toc-wrapper" data-v-996dafb6><h2 class="heading-size-7" data-v-996dafb6>Table of contents</h2><div class="toc" data-v-996dafb6><a href="#content" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/01</p><p data-v-996dafb6>Intro</p></a><a href="#toc-section-1" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/02</p><p data-v-996dafb6>Producer side duplicate messages</p></a><a href="#toc-section-2" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/03</p><p data-v-996dafb6>Consumer side duplicate messages</p></a><a href="#toc-section-3" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/04</p><p data-v-996dafb6>Conclusion</p></a></div></div><div id="content" class="content" data-v-996dafb6><p>Imagine you are working on a large-scale e-commerce application which uses Kafka for messaging.
All seems to be going well until one fine day you look at your metrics dashboard and you start noticing an uptick in the number of deliveries compared to the number of orders placed.
This leaves your team scrambling for an answer. After hours of debugging and a lot of coffee, the root cause turns out to not be a coding error, but duplicate messages flooding your topics.
In this blog, we will do a deep dive into the scenarios that can lead to duplicates and the various approaches that can be used to avoid them.</p>
<h1 id="toc-section-1"><a href="#producer-side-duplicate-messages" aria-hidden="true"><span class="icon icon-link"></span></a>Producer side duplicate messages</h1>
<p>Let us consider an order service that publishes messages to an order topic.</p>
<img src="/blog/kafka-message-duplication/producer-1.webp">
<p>In step 3, it is possible for the acknowledgement from Kafka to be lost due to transient network issues, such as temporary loss of network connectivity.
This will lead the order service to retry the same message until a successful acknowledgement is received, resulting in a duplicate.</p>
<img src="/blog/kafka-message-duplication/producer-2.webp">
<h2 id="resolution-idempotent-producer"><a href="#resolution-idempotent-producer" aria-hidden="true"><span class="icon icon-link"></span></a>Resolution: Idempotent Producer</h2>
<p><a href="https://en.wikipedia.org/wiki/Idempotence" target="_blank" rel="nofollow noopener noreferrer">Idempotent</a> producer can help resolve the issue.
To achieve this, the order service should be assigned a unique producer ID (PID) and each message published should be given a sequence number.
The combination of PID and the sequence number is tracked by Kafka as a unique ID for a message.
So, when a retry happens for an existing message, Kafka gives an acknowledgement back without appending the message to the log.</p>
<img src="/blog/kafka-message-duplication/producer-3.webp">
<p><a href="https://kafka.apache.org/documentation/#producerconfigs_enable.idempotence" target="_blank" rel="nofollow noopener noreferrer">Idempotency can be enabled in Kafka producer</a> by setting
<code class="language-inline-text">enable.idempotence</code> configuration property to <code class="language-inline-text">true</code> , <code class="language-inline-text">retries</code> to a value greater than 0 and <code class="language-inline-text">acks</code> to <code class="language-inline-text">all</code>.</p>
<p><code class="language-inline-text">enable.idempotence</code> — When set to <code class="language-inline-text">true</code> , the producer automatically does retries on retryable errors.
These can be errors that are transient in nature, such as leader not available or not enough replicas.</p>
<p><code class="language-inline-text">acks</code> — When set to <code class="language-inline-text">all</code> , Kafka makes sure that the leader waits for minimum number of in-sync replica partitions to have acknowledged the message before sending an acknowledgement to the producer.</p>
<h1 id="toc-section-2"><a href="#consumer-side-duplicate-messages" aria-hidden="true"><span class="icon icon-link"></span></a>Consumer side duplicate messages</h1>
<p>Now, let us consider a fulfillment service which:</p>
<ol>
<li>Reads messages from the Order Topic.</li>
<li>Performs a POST call to the Audit Service.</li>
<li>Creates a new record in the Fulfillment Table.</li>
<li>Publishes a message to the Fulfillment Topic.</li>
<li>Updates the offset in Kafka.</li>
</ol>
<img src="/blog/kafka-message-duplication/consumer-1.webp">
<p>If the instance running the service, does not process steps 2–5 within the set timeout, Kafka will assume that the service is dead.
This will cause the service instance to be removed from the consumer group and the partition to be rebalanced.
This means, the same message will then be assigned to, and processed by, another consumer in the group.</p>
<h2 id="resolution-idempotent-consumer"><a href="#resolution-idempotent-consumer" aria-hidden="true"><span class="icon icon-link"></span></a>Resolution: Idempotent Consumer</h2>
<p>Tracking all successfully consumed messages can help to avoid this scenario.
This can be achieved by assigning a unique ID to every message created at the producer side (order service),
and tracking them on the consumer side (fulfillment service) by storing each ID in a database table (Message ID Tracking Table).
When a message with a duplicate ID is received(identified by searching the Message ID Tracking Table), the offset is immediately updated and further processing skipped.</p>
<img src="/blog/kafka-message-duplication/consumer-2.webp">
<p>Also, inserting the record into the Tracking and Fulfillment Tables should done as a DB transaction.
This ensures that both actions are rollbacked in the event of any failure.</p>
<p><a href="https://stackoverflow.com/questions/62266911/jpa-stop-executing-code-in-transaction-if-exception-occurs" target="_blank" rel="nofollow noopener noreferrer">There is a possibility for transaction to fail, after publishing message to the fulfillment topic.</a>
This will lead to a retry, which will then result in a duplicate message in the fulfillment topic.
This approach does not address this scenario.</p>
<h2 id="resolution-idempotent-consumer--transactional-outbox"><a href="#resolution-idempotent-consumer--transactional-outbox" aria-hidden="true"><span class="icon icon-link"></span></a>Resolution: Idempotent Consumer + Transactional Outbox</h2>
<p>It is not possible to have a distributed transaction that would span the database as well as Kafka, as the latter does not support XA transactions.
So an approach to resolve the issue, will be to have an outbox table for capturing events to be published.
Writes to this table should be included in the same DB transaction which writes to the Tracking and Fulfillment tables.</p>
<img src="/blog/kafka-message-duplication/consumer-3.webp">
<p>This ensures database writes, and message publishing to Kafka, are an atomic action.
By using a Change Data Capture (CDC) tool, such as Kafka Connect or <a href="https://debezium.io/" target="_blank" rel="nofollow noopener noreferrer">Debezium</a>, the event can then be published to the fulfillment topic.</p>
<p>Even with this approach, there is a still a possibility for duplicate POST calls,
since retires can be triggered when there is a <a href="https://stackoverflow.com/questions/62266911/jpa-stop-executing-code-in-transaction-if-exception-occurs" target="_blank" rel="nofollow noopener noreferrer">transaction failure followed by a rollback after the making the call</a>.
This is irrespective of the order of execution of the call. The only resolution for which, will be to make sure that the POST call is idempotent on the receiver side.</p>
<h1 id="toc-section-3"><a href="#conclusion" aria-hidden="true"><span class="icon icon-link"></span></a>Conclusion</h1>
<p>These approaches introduce a lot of moving parts which increase complexity and maintainability.
So, it will be wise to take an incremental approach and implement them only when there are substantial metrics to support their incorporation.</p>
</div><hr data-v-996dafb6><div class="inner-section" data-v-996dafb6><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/vignesh.104602f3.png" alt="Vignesh Ravichandran" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Vignesh Ravichandran</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            Developer
          </p></div></div><p class="body-opensans-size-9" data-v-996dafb6></p><div class="social-links" data-v-996dafb6><!----><!----><a href="https://medium.com/@vignesh-ravichandran" target="_blank" class="heading-size-9" data-v-996dafb6>
          Medium
        </a></div></div><hr data-v-996dafb6><div class="related-articles" data-v-996dafb6><div class="flex-space-between" data-v-996dafb6><p class="heading-size-7" data-v-996dafb6>_related articles</p><a href="/blogs" class="heading-size-9 underline" data-v-996dafb6>View all</a></div><div class="flex-space-between blog-card-wrapper" data-v-996dafb6><a href="/blogs/smart-contracts-store-information" class="blog-card" data-v-996dafb6><img src="/assets/img/default-cover.55254b66.png" alt="Blockchain FTW" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/web</p><h3 data-v-996dafb6>Blockchain as public ledger</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Rahul Nitin Padalkar   5 min read
            </p></div></a><a href="/blogs/using-tarka-chat-in-your-react-vue-apps" class="blog-card" data-v-996dafb6><img src="/assets/img/Photo-by-Volodymyr-Hryshchenko-on-Unsplash.97698903.webp" alt="Using Tarka Chat in your React/Vue apps" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/web</p><h3 data-v-996dafb6>Using Tarka Chat in your React/Vue apps</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Shamil Siddique   5 min read
            </p></div></a></div></div><div class="lets-talk" data-v-188e6a71><div class="message heading-size-7" data-v-188e6a71>
    Let’s build digital solutions together.
  </div><div class="action-container" data-v-188e6a71><div class="action-button heading-size-5" data-v-188e6a71><div data-v-188e6a71>Get in touch</div><div class="arrow" data-v-188e6a71>-&gt;</div></div><img src="/assets/img/talk.71d1d2f3.svg" alt="Lenny Face" data-v-188e6a71></div></div></div></div><div data-v-996dafb6></div></div><div id="footer" class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="site-footer" data-v-0a037a4b data-v-b5a9baaa><ul class="main-nav footer" data-v-748716d7 data-v-0a037a4b><div class="primary fadeIn" data-v-748716d7><li data-v-748716d7><a href="/genai" data-v-748716d7>/GenAI</a></li><li data-v-748716d7><a href="https://design.tarkalabs.com/" target="_self" data-v-748716d7>/Design</a></li><li data-v-748716d7><a href="/develop" data-v-748716d7>/Develop</a></li><li data-v-748716d7><a href="/case-studies" data-v-748716d7>
        /Case_Studies
      </a></li><li data-v-748716d7><a href="/careers" data-v-748716d7>/Careers</a></li><li data-v-748716d7><a href="/about" data-v-748716d7>/About</a></li><li data-v-748716d7><a href="/contact" data-v-748716d7>/Contact</a></li></div></ul><div class="subnav" data-v-0a037a4b><ul class="sub body-jetbrains-size-11 footer fadeIn" data-v-3cc3824e data-v-0a037a4b><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul><div data-v-fae945d8 data-v-0a037a4b><a href="https://twitter.com/tarkalabs" target="_blank" rel="noopener" class="external" data-v-fae945d8>Twitter</a><a href="https://in.linkedin.com/company/tarka-labs" target="_blank" rel="noopener" class="external" data-v-fae945d8>LinkedIn</a></div><div class="sedin" data-v-0a037a4b><a href="https://sedintechnologies.com/" target="_blank" rel="noopener" class="external" data-v-0a037a4b>Tarka Labs is a division of Sedin Technologies</a></div></div></div></div><div data-v-996dafb6></div></div></div></div></div>
    <script src="/assets/js/app.0e5d4a8b.js" defer></script><script src="/assets/js/page--src--templates--blog-vue.2099f288.js" defer></script><script data-vue-tag="ssr" src="https://unpkg.com/@lottiefiles/lottie-player@0.4.0/dist/lottie-player.js" data-body="true"></script>
  </body>
</html>
