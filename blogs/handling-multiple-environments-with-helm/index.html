<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Handling multiple environments with Helm · Tarka Labs - Tarka Labs</title><meta name="gridsome:hash" content="349efe6f807fb4dc611d3a5c293683182afb837a"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="viewport" content="width=device-width, initial-scale=1.0"><meta data-vue-tag="ssr" property="og:title" content="Handling multiple environments with Helm · Tarka Labs"><meta data-vue-tag="ssr" property="og:description" content="Handling multiple environments with Helm"><meta data-vue-tag="ssr" property="og:image" content="/assets/img/handling-multiple-environments-with-helm.622d96e3.webp"><meta data-vue-tag="ssr" property="og:image:height" content="627"><meta data-vue-tag="ssr" property="og:image:width" content="1200"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.92f6d0f06feb6aec5e019521ff224fd8.png"><link rel="preload" href="/assets/css/0.styles.bff8b3e8.css" as="style"><link rel="preload" href="/assets/js/app.821b57fa.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--blog-vue.80bca3bd.js" as="script"><link rel="stylesheet" href="/assets/css/0.styles.bff8b3e8.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
    <meta
      name="google-site-verification"
      content="j7cLUK-kxGEpMOY7valSkamH4kQe_l38yMMAXbpk19U"
    />
    <noscript>
      <div class="noscript-container">
        <a href="/" class="noscript-logo">Tarka <br />_Labs</a>
        <div class="noscript-text-container">
          <h1>Uh oh! Looks like <span>JavaScript</span> is disabled.</h1>
          <p>
            Bitman requires <span>JavaScript</span> to fuel his thirst to end
            bad UX and lazy design, which is necessary to give you the best
            viewing experience possible. Please enable it to continue to our
            website.
          </p>
        </div>
      </div>
    </noscript>
  </head>

  <body >
    <div><div id="app" data-server-rendered="true" data-v-b5a9baaa><div data-v-b5a9baaa><div id="banner-section" data-v-b5a9baaa><div class="banner" style="background:;display:none;" data-v-b5a9baaa><div class="layout" data-v-b5a9baaa><div data-v-b5a9baaa></div><div class="hero heading-size-5" style="color:#ffffff;" data-v-b5a9baaa></div><div data-v-b5a9baaa></div></div></div><div data-v-b5a9baaa></div></div><div class="sidebar" data-v-d6d2017e data-v-b5a9baaa><div class="nav" data-v-d6d2017e><div class="fixed" data-v-d6d2017e><a href="/" data-v-9b1a4c9c data-v-d6d2017e> TARKA<br data-v-9b1a4c9c>_LABS </a><div class="menu" data-v-50705736 data-v-d6d2017e><div class="control" style="stroke:black;" data-v-50705736><div class="spinner heading-size-9" data-v-02ea7230 data-v-50705736><span class="side-menu-symbol" data-v-02ea7230><span class="menu-symbol rotate180t90" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span><span class="menu-symbol rotate90t0" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span></span><span style="vertical-align: middle" data-v-02ea7230> menu </span></div><div class="active-page body-jetbrains-size-11 fade-in" data-v-128e5feb data-v-50705736>
  
</div></div><div class="items hidden" data-v-50705736><ul class="main-nav" data-v-04879724 data-v-50705736><div class="primary fadeOut sidebar" data-v-04879724><li data-v-04879724><a href="/genai" data-v-04879724>/GenAI</a></li><li data-v-04879724><a href="https://solutions.tarkalabs.com/design/" target="_self" data-v-04879724>/Design</a></li><li data-v-04879724><a href="/develop" data-v-04879724>/Develop</a></li><li data-v-04879724><a href="/case-studies" data-v-04879724>
        /Case_Studies
      </a></li><li data-v-04879724><a href="/careers" data-v-04879724>/Careers</a></li><li data-v-04879724><a href="/about" data-v-04879724>/About</a></li><li data-v-04879724><a href="/contact" data-v-04879724>/Contact</a></li></div></ul><ul class="sub body-jetbrains-size-11 fadeOut sidebar" data-v-3cc3824e data-v-50705736><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul></div></div><a href="/contact" class="heading-size-9" data-v-573e12d8 data-v-d6d2017e>
  Get in<br data-v-573e12d8>touch<span class="arrow" data-v-573e12d8>-&gt;</span></a></div></div><!----></div><div class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="blog-details-page" data-v-996dafb6><div class="inner-section" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>
        /devops - 4 min read
      </p><h1 class="title" data-v-996dafb6>Handling multiple environments with Helm</h1><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/madhava.695f658a.jpg" alt="Madhava Reddy SV" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Madhava Reddy SV</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            DevOps
          </p></div></div></div><img src="/assets/img/handling-multiple-environments-with-helm.622d96e3.webp" alt="Handling multiple environments with Helm" class="header-img" data-v-996dafb6><div class="toc-wrapper" data-v-996dafb6><h2 class="heading-size-7" data-v-996dafb6>Table of contents</h2><div class="toc" data-v-996dafb6><a href="#content" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/01</p><p data-v-996dafb6>Intro</p></a><a href="#toc-section-1" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/02</p><p data-v-996dafb6>Here’s the project structure at a glance.</p></a><a href="#toc-section-2" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/03</p><p data-v-996dafb6>So you’ve defined all the yaml files. Now what?</p></a><a href="#toc-section-3" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/04</p><p data-v-996dafb6>Here’s how you can update all your deployments.</p></a><a href="#toc-section-4" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/05</p><p data-v-996dafb6>How to setup and run Helm commands.</p></a><a href="#toc-section-5" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/06</p><p data-v-996dafb6>And we’re done!</p></a></div></div><div id="content" class="content" data-v-996dafb6><p>Have you tried <a href="https://helm.sh/" target="_blank" rel="nofollow noopener noreferrer">Helm</a>?</p>
<p>It provisions all your kubernetes applications beautifully, but I’ve always been mildly frustrated that it doesn’t support multiple product environments by default using its single values file.</p>
<p>This is a ubiquitous problem — nobody likes to have the same code copied with different values for multiple environments. It is clunky and makes template changes hard in the future, with the need to update these separately for each environment’s source code. So I decided to roll up my sleeves and do something about it.</p>
<p>In this post, I am going to cover how I’ve achieved support for multiple kubernetes environments using Helm.</p>
<p>Each kubernetes environment requires handling the below aspects. Generally, all non secret values should be put in <a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank" rel="nofollow noopener noreferrer">kubernetes configmap(s)</a> and all secret values should be in <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="nofollow noopener noreferrer">kubernetes secrets</a>.</p>
<ol>
<li>Environment specific constants like urls etc. - mostly non secret values which can be safely checked in to git (Kubernetes Configmap)</li>
<li>Environment specific secret values like db username and passwords etc. - can’t be checked into git (<a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="nofollow noopener noreferrer">Kubernetes Secrets</a>)</li>
<li>Updating <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="nofollow noopener noreferrer">kubernetes deployments</a> (<a href="https://kubernetes.io/docs/concepts/workloads/pods/" target="_blank" rel="nofollow noopener noreferrer">pods</a>) when configmap / secrets gets updated</li>
</ol>
<h1 id="toc-section-1"><a href="#heres-the-project-structure-at-a-glance" aria-hidden="true"><span class="icon icon-link"></span></a>Here’s the project structure at a glance.</h1>
<img src="/blog/handling-multiple-environments-with-helm/1.webp">
<p>The <a href="https://github.com/SVMadhavaReddy/helm-multiple-environments/tree/main/docker" target="_blank" rel="nofollow noopener noreferrer"><strong>docker</strong></a> folder was created for generating a simple docker image, which will demonstrate my approach.</p>
<p>The <a href="https://github.com/SVMadhavaReddy/helm-multiple-environments/tree/main/environments" target="_blank" rel="nofollow noopener noreferrer"><strong>environments</strong></a> folder is where we’ll need to put all our environment specific files.</p>
<p>Every environment has 3 files inside the <a href="https://github.com/SVMadhavaReddy/helm-multiple-environments/tree/main/environments" target="_blank" rel="nofollow noopener noreferrer"><strong>environments</strong></a> folder. These are the Helm values file, configmap file and secrets file. The secrets files won’t be checked into git and only available to our CI/CD pipelines.</p>
<p><strong>FYI</strong>: This is a sample project that’s meant to give you an understanding of how this works. Feel free to make changes as needed for your application. I can’t explain the <a href="https://helm.sh/docs/topics/charts/" target="_blank" rel="nofollow noopener noreferrer">Helm structure</a> and its way of working because it’s out of scope for this post. If you want to check out the source code, you can view <a href="https://github.com/SVMadhavaReddy/helm-multiple-environments/tree/main" target="_blank" rel="nofollow noopener noreferrer">it here</a>.</p>
<p>Both the <strong>configmap.&#x3C;env>.yaml</strong> and <strong>secrets.&#x3C;env>.yaml</strong> files are simple key value defined files. Except that the value of each key in the secrets file has to be <strong>base64</strong> encoded. All key value pairs should be defined as <strong><em>KEY: VALUE</em></strong> with a newline between each key pair.</p>
<p>Helm requires values files to be supplied for the <strong>helm install/upgrade</strong> command. But we’ve got two values files at the root and environments folder levels. And by default, Helm will read the root level values file, even if you don’t specify any values file explicitly.</p>
<p>Ports and probes that are common to all the environments and they should be in the root level values file. This way, we won’t need to make changes in multiple places. And all environment specific values should reside in the values..yaml file. I won’t be focussing on how to define values for Helm here, so if you need any help, please go through this <a href="https://helm.sh/docs/chart_best_practices/values/" target="_blank" rel="nofollow noopener noreferrer">official documentation</a>.
<h1 id="toc-section-2"><a href="#so-youve-defined-all-the-yaml-files-now-what" aria-hidden="true"><span class="icon icon-link"></span></a>So you’ve defined all the yaml files. Now what?</h1>
</p><p>Once you’re done updating both the configmap and secret yaml files, they won’t be directly applied to the cluster. Instead you need to carry out these steps for creating and modifying configmap and secrets.</p>
<p><strong>Configmap:</strong> Create the <strong>configmap.yaml</strong> file under the <strong>templates</strong> directory and paste the below content.</p>
<div class="gridsome-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
 <span class="token key atrule">name</span><span class="token punctuation">:</span> helm<span class="token punctuation">-</span>multi<span class="token punctuation">-</span>env<span class="token punctuation">-</span>configmap
 <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.namespace <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> printf "environments/configmap.%s.yaml" .Values.namespace <span class="token punctuation">|</span> .Files.Get <span class="token punctuation">|</span> indent 2 <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></div>
<p><strong>Secrets:</strong> Create the <strong>secrets.yaml</strong> file under the <strong>templates</strong> directory and paste the below content.</p>
<div class="gridsome-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helm<span class="token punctuation">-</span>multi<span class="token punctuation">-</span>env<span class="token punctuation">-</span>secrets
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.namespace <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> printf "environments/secrets.%s.yaml" .Values.namespace <span class="token punctuation">|</span> .Files.Get <span class="token punctuation">|</span> indent 2 <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></div>
<p>Once you’ve created both these files under <strong>templates</strong>, both the kubernetes configmap and secrets files will be created and updated on the cluster from the next CI/CD pipeline run.</p>
<h1 id="toc-section-3"><a href="#heres-how-you-can-update-all-your-deployments" aria-hidden="true"><span class="icon icon-link"></span></a>Here’s how you can update all your deployments.</h1>
<p>Add both the annotations mentioned below to all your deployments and whenever the configmap or secrets files are updated, your pods will be restarted. Once any file changes, kubernetes will try to redeploy all deployments which are configured with below annotations at once. Please make sure that you have at least two replicas for each deployment, for high availability.</p>
<div class="gridsome-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token punctuation">---</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">checksum/configmap</span><span class="token punctuation">:</span>
          <span class="token punctuation">{</span>
            <span class="token punctuation">{</span>
              printf "environments/configmap.%s.yaml" .Values.namespace <span class="token punctuation">|</span> .Files.Get <span class="token punctuation">|</span> sha256sum
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token key atrule">checksum/secrets</span><span class="token punctuation">:</span>
          <span class="token punctuation">{</span>
            <span class="token punctuation">{</span>
              printf "environments/secrets.%s.yaml" .Values.namespace <span class="token punctuation">|</span> .Files.Get <span class="token punctuation">|</span> sha256sum
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span></code></pre></div>
<h1 id="toc-section-4"><a href="#how-to-setup-and-run-helm-commands" aria-hidden="true"><span class="icon icon-link"></span></a>How to setup and run Helm commands.</h1>
<p>Usually a Helm upgrade or install requires the <strong>release_name</strong>, <strong>chart_folder</strong> and other necessary flags. You’ll need to run your Helm commands with explicit flag <strong>-f</strong> or <strong>--values,</strong> with the value as the path to your environment specific values file. And make sure you add your application specific other Helm flags if required. Here’s a master command that will handle everything from Helm release installs to upgrades, if the release already exists.</p>
<div class="gridsome-highlight" data-language="text"><pre class="language-text"><code class="language-text">helm upgrade --install --create-namespace -n &lt;namespace> -f
environments/values.&lt;environment>.yaml &lt;your_release_name>
&lt;your_chart_path></code></pre></div>
<p><strong>Note:</strong> Although you’ve defined the <strong>namespace</strong> value inside the yaml file, you will need to provide it with your command explicitly as Helm needs this namespace to save and retrieve Helm releases.</p>
<h1 id="toc-section-5"><a href="#and-were-done" aria-hidden="true"><span class="icon icon-link"></span></a>And we’re done!</h1>
<p>With this article, I hope I’ve clarified how you can make Helm work with your multiple environment setup. Extend this work with your own customisations wherever applicable and drop a comment if you need any clarifications!</p>
<blockquote>
<p>Hello Montreal! We’ll be at the <a href="https://startupfestival.com/" target="_blank" rel="nofollow noopener noreferrer">Startupfest ’22</a> all three days, so drop by and say hi. We’d love to see what you’re building, and early birds get a free (limited) design audit or tech consultation. DM us on Twitter (<a href="https://twitter.com/tarkalabs" target="_blank" rel="nofollow noopener noreferrer">@tarkalabs</a>) and let’s talk.</p>
</blockquote>
</div><hr data-v-996dafb6><div class="inner-section" data-v-996dafb6><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/madhava.695f658a.jpg" alt="Madhava Reddy SV" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Madhava Reddy SV</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            DevOps
          </p></div></div><p class="body-opensans-size-9" data-v-996dafb6>He is still thinking what to write about him</p><div class="social-links" data-v-996dafb6><!----><!----><!----></div></div><hr data-v-996dafb6><div class="related-articles" data-v-996dafb6><div class="flex-space-between" data-v-996dafb6><p class="heading-size-7" data-v-996dafb6>_related articles</p><a href="/blogs" class="heading-size-9 underline" data-v-996dafb6>View all</a></div><div class="flex-space-between blog-card-wrapper" data-v-996dafb6><a href="/blogs/opentext-magellan-aks-unofficial-deployment-guide" class="blog-card" data-v-996dafb6><img src="/assets/img/default-cover.55254b66.png" alt="OpenText Magellan and AKS: An unofficial deployment guide" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/devops</p><h3 data-v-996dafb6>OpenText Magellan and AKS: An unofficial deployment guide</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Shamil Siddique   11 min read
            </p></div></a><a href="/blogs/aws-ecs-monitoring-solution" class="blog-card" data-v-996dafb6><img src="/assets/img/cover.48fab8a3.gif" alt="The only in-depth AWS ECS monitoring solution you'll need" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/devops</p><h3 data-v-996dafb6>The only in-depth AWS ECS monitoring solution you'll need</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Madhava Reddy SV   6 min read
            </p></div></a></div></div><div class="lets-talk" data-v-188e6a71><div class="message heading-size-7" data-v-188e6a71>
    Let’s build digital solutions together.
  </div><div class="action-container" data-v-188e6a71><div class="action-button heading-size-5" data-v-188e6a71><div data-v-188e6a71>Get in touch</div><div class="arrow" data-v-188e6a71>-&gt;</div></div><img src="/assets/img/talk.71d1d2f3.svg" alt="Lenny Face" data-v-188e6a71></div></div></div></div><div data-v-996dafb6></div></div><div id="footer" class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="site-footer" data-v-0a037a4b data-v-b5a9baaa><ul class="main-nav footer" data-v-04879724 data-v-0a037a4b><div class="primary fadeIn" data-v-04879724><li data-v-04879724><a href="/genai" data-v-04879724>/GenAI</a></li><li data-v-04879724><a href="https://solutions.tarkalabs.com/design/" target="_self" data-v-04879724>/Design</a></li><li data-v-04879724><a href="/develop" data-v-04879724>/Develop</a></li><li data-v-04879724><a href="/case-studies" data-v-04879724>
        /Case_Studies
      </a></li><li data-v-04879724><a href="/careers" data-v-04879724>/Careers</a></li><li data-v-04879724><a href="/about" data-v-04879724>/About</a></li><li data-v-04879724><a href="/contact" data-v-04879724>/Contact</a></li></div></ul><div class="subnav" data-v-0a037a4b><ul class="sub body-jetbrains-size-11 footer fadeIn" data-v-3cc3824e data-v-0a037a4b><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul><div data-v-fae945d8 data-v-0a037a4b><a href="https://twitter.com/tarkalabs" target="_blank" rel="noopener" class="external" data-v-fae945d8>Twitter</a><a href="https://in.linkedin.com/company/tarka-labs" target="_blank" rel="noopener" class="external" data-v-fae945d8>LinkedIn</a></div><div class="sedin" data-v-0a037a4b><a href="https://sedintechnologies.com/" target="_blank" rel="noopener" class="external" data-v-0a037a4b>Tarka Labs is a division of Sedin Technologies</a></div></div></div></div><div data-v-996dafb6></div></div></div></div></div>
    <script src="/assets/js/app.821b57fa.js" defer></script><script src="/assets/js/page--src--templates--blog-vue.80bca3bd.js" defer></script><script data-vue-tag="ssr" src="https://unpkg.com/@lottiefiles/lottie-player@0.4.0/dist/lottie-player.js" data-body="true"></script>
  </body>
</html>
