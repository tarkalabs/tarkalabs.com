<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Implementing Serverless Batch Transcription with AWS Step Functions and Azure AI Services · Tarka Labs - Tarka Labs</title><meta name="gridsome:hash" content="ca63d4b895843a4474e6c91fad541ae01319d09e"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="viewport" content="width=device-width, initial-scale=1.0"><meta data-vue-tag="ssr" property="og:title" content="Implementing Serverless Batch Transcription with AWS Step Functions and Azure AI Services · Tarka Labs"><meta data-vue-tag="ssr" property="og:description" content="Implementing Serverless Batch Transcription with AWS Step Functions and Azure AI Services"><meta data-vue-tag="ssr" property="og:image" content="/assets/img/batch-transcription.e03c0d91.webp"><meta data-vue-tag="ssr" property="og:image:height" content="627"><meta data-vue-tag="ssr" property="og:image:width" content="1200"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.92f6d0f06feb6aec5e019521ff224fd8.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.92f6d0f06feb6aec5e019521ff224fd8.png"><link rel="preload" href="/assets/css/0.styles.e88452e3.css" as="style"><link rel="preload" href="/assets/js/app.dd4f7263.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--blog-vue.cebd2415.js" as="script"><link rel="stylesheet" href="/assets/css/0.styles.e88452e3.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
    <meta
      name="google-site-verification"
      content="j7cLUK-kxGEpMOY7valSkamH4kQe_l38yMMAXbpk19U"
    />
    <noscript>
      <div class="noscript-container">
        <a href="/" class="noscript-logo">Tarka <br />_Labs</a>
        <div class="noscript-text-container">
          <h1>Uh oh! Looks like <span>JavaScript</span> is disabled.</h1>
          <p>
            Bitman requires <span>JavaScript</span> to fuel his thirst to end
            bad UX and lazy design, which is necessary to give you the best
            viewing experience possible. Please enable it to continue to our
            website.
          </p>
        </div>
      </div>
    </noscript>
  </head>

  <body >
    <div><div id="app" data-server-rendered="true" data-v-b5a9baaa><div data-v-b5a9baaa><div id="banner-section" data-v-b5a9baaa><div class="banner" style="background:;display:none;" data-v-b5a9baaa><div class="layout" data-v-b5a9baaa><div data-v-b5a9baaa></div><div class="hero heading-size-5" style="color:#ffffff;" data-v-b5a9baaa></div><div data-v-b5a9baaa></div></div></div><div data-v-b5a9baaa></div></div><div class="sidebar" data-v-d6d2017e data-v-b5a9baaa><div class="nav" data-v-d6d2017e><div class="fixed" data-v-d6d2017e><a href="/" data-v-9b1a4c9c data-v-d6d2017e> TARKA<br data-v-9b1a4c9c>_LABS </a><div class="menu" data-v-50705736 data-v-d6d2017e><div class="control" style="stroke:black;" data-v-50705736><div class="spinner heading-size-9" data-v-02ea7230 data-v-50705736><span class="side-menu-symbol" data-v-02ea7230><span class="menu-symbol rotate180t90" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span><span class="menu-symbol rotate90t0" data-v-02ea7230><svg height="10" width="10" data-v-02ea7230><line x1="0" y1="5" x2="10" y2="5" style="stroke-width: 2" data-v-02ea7230></line></svg></span></span><span style="vertical-align: middle" data-v-02ea7230> menu </span></div><div class="active-page body-jetbrains-size-11 fade-in" data-v-128e5feb data-v-50705736>
  
</div></div><div class="items hidden" data-v-50705736><ul class="main-nav" data-v-04879724 data-v-50705736><div class="primary fadeOut sidebar" data-v-04879724><li data-v-04879724><a href="/genai" data-v-04879724>/GenAI</a></li><li data-v-04879724><a href="https://solutions.tarkalabs.com/design/" target="_self" data-v-04879724>/Design</a></li><li data-v-04879724><a href="/develop" data-v-04879724>/Develop</a></li><li data-v-04879724><a href="/case-studies" data-v-04879724>
        /Case_Studies
      </a></li><li data-v-04879724><a href="/careers" data-v-04879724>/Careers</a></li><li data-v-04879724><a href="/about" data-v-04879724>/About</a></li><li data-v-04879724><a href="/contact" data-v-04879724>/Contact</a></li></div></ul><ul class="sub body-jetbrains-size-11 fadeOut sidebar" data-v-3cc3824e data-v-50705736><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul></div></div><a href="/contact" class="heading-size-9" data-v-573e12d8 data-v-d6d2017e>
  Get in<br data-v-573e12d8>touch<span class="arrow" data-v-573e12d8>-&gt;</span></a></div></div><!----></div><div class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="blog-details-page" data-v-996dafb6><div class="inner-section" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>
        /AI - 8 min read
      </p><h1 class="title" data-v-996dafb6>Implementing Serverless Batch Transcription with AWS Step Functions and Azure AI Services</h1><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/k7.d295c558.png" alt="Kesavan" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Kesavan</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            Developer
          </p></div></div></div><img src="/assets/img/batch-transcription.e03c0d91.webp" alt="Implementing Serverless Batch Transcription with AWS Step Functions and Azure AI Services" class="header-img" data-v-996dafb6><div class="toc-wrapper" data-v-996dafb6><h2 class="heading-size-7" data-v-996dafb6>Table of contents</h2><div class="toc" data-v-996dafb6><a href="#content" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/01</p><p data-v-996dafb6>Intro</p></a><a href="#toc-section-1" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/02</p><p data-v-996dafb6>Problem statement</p></a><a href="#toc-section-2" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/03</p><p data-v-996dafb6>Azure batch transcription</p></a><a href="#toc-section-3" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/04</p><p data-v-996dafb6>AWS Step function</p></a><a href="#toc-section-4" class="heading-size-9 heading" data-v-996dafb6><p data-v-996dafb6>/05</p><p data-v-996dafb6>Conclusion</p></a></div></div><div id="content" class="content" data-v-996dafb6><h1 id="toc-section-1"><a href="#problem-statement" aria-hidden="true"><span class="icon icon-link"></span></a>Problem statement</h1>
<p>Speech-to-Text (STT) is the process of converting audio data into text format.
At a high level, our requirement is to transcribe call recordings located in an Azure storage container using Azure Batch Transcription.
We then need to process this transcribed data and save it to an AWS S3 bucket.</p>
<p>In this article, we’ll explore how to leverage Azure Batch Transcription for transcribing audio data and utilize AWS Step Functions to create
and process the final results in an automated, end-to-end fashion.</p>
<figure><img src="/blog/batch-transcription/components.webp" alt="Speech to text High level Architecture"><figcaption>Speech to text High level Architecture</figcaption></figure>
<h1 id="toc-section-2"><a href="#azure-batch-transcription" aria-hidden="true"><span class="icon icon-link"></span></a>Azure batch transcription</h1>
<p>Azure cognitive service provides a batch transcription service for transcribing large amounts of audio to text. It offers various rest APIs to manage batch transcriptions. The process works as follows:</p>
<p><strong>Send audio recordings</strong>: Use the Create Transcription API to submit your set of audio recordings.<br>
<strong>Job processing</strong>: The system starts processing the recordings in the background.<br>
<strong>Status check</strong>: You can use the Get Transcription API to check the status of the job periodically.<br>
<strong>Download results</strong>: Once the job is complete, use the Get Transcription Files API to retrieve a list of downloadable links for the transcribed text.</p>
<h2 id="create-transcription-api"><a href="#create-transcription-api" aria-hidden="true"><span class="icon icon-link"></span></a>Create transcription API</h2>
<p>Create transcription API will create transcription job with the given properties,</p>
<div class="gridsome-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">--location</span> <span class="token string">'https://eastus.api.cognitive.microsoft.com/speechtotext/v3.2-preview.1/transcriptions'</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--header</span> <span class="token string">'Content-Type: application/json'</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--header</span> <span class="token string">'Ocp-Apim-Subscription-Key: {subscription key}'</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">'{
    "properties": {
        "punctuationMode": "DictatedAndAutomatic",
        "profanityFilterMode": "Masked",
        "timeToLive": "PT8H",
        "diarizationEnabled": true,
        "diarization": {
            "speakers": {
                "minCount": 1,
                "maxCount": 5
            }
        }
    },
    "model": {
        "self": "https://eastus.api.cognitive.microsoft.com/speechtotext/v3.2-preview.1/models/base/71cbd7af-3212-43ab-8695-666fb28ffef7"
    },
    "locale": "en-US",
    "displayName": "testing transcription",
    "contentUrls": [
        "container_url1",
        "container_url2",
        "container_url3"
    ]
}'</span></code></pre></div>
<p>Some highlights in the request body:</p>
<ul>
<li><strong>Model</strong>: We are using the whisper large-v2 model. You can find other available models using the Get Base Models API. Please note that the whisper model does not provide lexical text in the results.</li>
<li><strong>Diarization</strong>: We have set the <strong>diarization</strong> property to a minimum of 1 speaker and a maximum of 5 speakers.</li>
<li><strong>Time to Live</strong>: We have configured a time-to-live of 8 hours. This means that all transcription resources will be automatically deleted after 8 hours.</li>
<li>
<p><strong>Content URLs</strong>: Content URLs must be accessible by Azure. You can use any public URL or configure the data in an Azure storage container and provide the blob URL as the content URL. If you want to add more security and protect your data with Azure’s private network, you can use <a href="https://learn.microsoft.com/en-us/azure/ai-services/speech-service/bring-your-own-storage-speech-resource-speech-to-text" target="_blank" rel="nofollow noopener noreferrer">Bring Your Own Storage (BYOS)</a>.</p>
<p>The Create Transcription API returns a created transcription resource containing a <code class="language-inline-text">transcription_id</code>. You can use this ID to fetch the transcription results.</p>
</li>
</ul>
<h2 id="get-transcription-api"><a href="#get-transcription-api" aria-hidden="true"><span class="icon icon-link"></span></a>Get transcription API</h2>
<p>Get transcription API is used to get the transcription details, it tells us the current status of the transcription Job and the other transcription properties.</p>
<div class="gridsome-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">--location</span> <span class="token punctuation">\</span>
<span class="token string">'https://eastus.api.cognitive.microsoft.com/speechtotext/v3.2-preview.1/transcriptions/{transcription_id}'</span><span class="token punctuation">\</span>
<span class="token parameter variable">--header</span> <span class="token string">'Ocp-Apim-Subscription-Key: {subscription key}'</span></code></pre></div>
<h2 id="get-transcription-files-api"><a href="#get-transcription-files-api" aria-hidden="true"><span class="icon icon-link"></span></a>Get transcription files API</h2>
<p>Get transcription files API will give the transcription results,</p>
<div class="gridsome-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">--location</span> <span class="token punctuation">\</span>
<span class="token string">'https://eastus.api.cognitive.microsoft.com/speechtotext/v3.2-preview.1/transcriptions/{transcription_id}/files'</span><span class="token punctuation">\</span>
<span class="token parameter variable">--header</span> <span class="token string">'Ocp-Apim-Subscription-Key: {subscription key}'</span></code></pre></div>
<p>The response will include a <code class="language-inline-text">link</code> field, which you can use to download the data.
It will also include a <code class="language-inline-text">kind</code> field. If the <code class="language-inline-text">kind</code> is <code class="language-inline-text">Transcription</code>, the link will contain the transcription result.
If the <code class="language-inline-text">kind</code> is <code class="language-inline-text">TranscriptionReport</code>, the response will provide the following information:</p>
<ul>
<li>The number of recordings successfully transcribed</li>
<li>The number of recordings that failed transcription.</li>
</ul>
<div class="gridsome-highlight" data-language="json"><pre class="language-json"><code class="language-json"># TranscriptionReport data
<span class="token punctuation">{</span>
  <span class="token property">"successfulTranscriptionsCount"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"failedTranscriptionsCount"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">"details"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"content_url1"</span><span class="token punctuation">,</span>
      <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"Succeeded"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"content_url2"</span><span class="token punctuation">,</span>
      <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"Failed"</span><span class="token punctuation">,</span>
      <span class="token property">"errorMessage"</span><span class="token operator">:</span> <span class="token string">"Reason RecordingsUriNotFound, Details: Input file was not found at the provided URI. StatusCode: BlobNotFound. (JobId e6a0f478-a2ca-4f34-ad70-976713bc7ab0)."</span><span class="token punctuation">,</span>
      <span class="token property">"errorKind"</span><span class="token operator">:</span> <span class="token string">"RecordingsUriNotFound"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"content_url3"</span><span class="token punctuation">,</span>
      <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"Failed"</span><span class="token punctuation">,</span>
      <span class="token property">"errorMessage"</span><span class="token operator">:</span> <span class="token string">"Reason RecordingsUriNotFound, Details: Input file was not found at the provided URI. StatusCode: BlobNotFound. (JobId e6a0f478-a2ca-4f34-ad70-976713bc7ab0)."</span><span class="token punctuation">,</span>
      <span class="token property">"errorKind"</span><span class="token operator">:</span> <span class="token string">"RecordingsUriNotFound"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<h1 id="toc-section-3"><a href="#aws-step-function" aria-hidden="true"><span class="icon icon-link"></span></a>AWS Step function</h1>
<p>AWS Step Functions works like a state machine. You can define the start, next, and end states using Amazon States Language (ASL).
Each state accepts an input, allows you to define tasks to be performed, and produces an output.
This output becomes the input of the next state, if any.</p>
<p>Step Functions supports a variety of types, including <code class="language-inline-text">task</code>, <code class="language-inline-text">wait</code>, <code class="language-inline-text">choice</code>, <code class="language-inline-text">parallel</code>, and <code class="language-inline-text">map</code>.
You can also embed other AWS services within a particular state, such as <code class="language-inline-text">Lambda</code>, <code class="language-inline-text">SQS</code>, <code class="language-inline-text">SNS</code>, and <code class="language-inline-text">Batch jobs</code>.</p>
<h2 id="task-state-config-for-lambda-resource"><a href="#task-state-config-for-lambda-resource" aria-hidden="true"><span class="icon icon-link"></span></a>Task state config for Lambda resource</h2>
<p>Task states can handle the invocation of Lambda functions, and the return value of each Lambda function becomes the input for the subsequent state.
Task state definition will look like this,</p>
<div class="gridsome-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"&lt;State name>"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"Task"</span><span class="token punctuation">,</span>
  <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:states:::lambda:invoke"</span><span class="token punctuation">,</span>
  <span class="token property">"Parameters"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"Payload.$"</span><span class="token operator">:</span> <span class="token string">"$"</span><span class="token punctuation">,</span>
    <span class="token property">"FunctionName"</span><span class="token operator">:</span> <span class="token string">"&lt;LAMBDA_ARN>"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"InputPath"</span><span class="token operator">:</span> <span class="token string">"$.transcription"</span><span class="token punctuation">,</span>
  <span class="token property">"ResultPath"</span><span class="token operator">:</span> <span class="token string">"$.data"</span>
  <span class="token property">"ResultSelector"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"status.$"</span><span class="token operator">:</span> <span class="token string">"$.Payload.status"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"Retry"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"ErrorEquals"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"Lambda.ServiceException"</span><span class="token punctuation">,</span>
        <span class="token string">"Lambda.AWSLambdaException"</span><span class="token punctuation">,</span>
        <span class="token string">"Lambda.SdkClientException"</span><span class="token punctuation">,</span>
        <span class="token string">"Lambda.TooManyRequestsException"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"IntervalSeconds"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">"MaxAttempts"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">"BackoffRate"</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"Catch"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"ErrorEquals"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"Error1"</span><span class="token punctuation">,</span>
            <span class="token string">"Error2"</span><span class="token punctuation">,</span>
            <span class="token string">"Error3"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Next"</span><span class="token operator">:</span> <span class="token string">"Fail State 1"</span><span class="token punctuation">,</span>
      <span class="token property">"ResultPath"</span><span class="token operator">:</span> <span class="token string">"$.error"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"ErrorEquals"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"Error4"</span><span class="token punctuation">,</span>
            <span class="token string">"Error5"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Next"</span><span class="token operator">:</span> <span class="token string">"Fail State 2"</span><span class="token punctuation">,</span>
      <span class="token property">"ResultPath"</span><span class="token operator">:</span> <span class="token string">"$.error"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"Next"</span><span class="token operator">:</span> <span class="token string">"&lt;Next state name>"</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We’ve added a <code class="language-inline-text">catch</code> and <code class="language-inline-text">retry</code> block. Because Lambdas are anonymous and their availability can’t be guaranteed, we’ve implemented a <code class="language-inline-text">retry block</code> to handle any Lambda-related exceptions.
Additionally, we’ve included a <code class="language-inline-text">catch block</code> to capture specific known errors and route them to appropriate next states.
If the Lambda throws errors like <code class="language-inline-text">Error1</code>, <code class="language-inline-text">Error2</code>, and <code class="language-inline-text">Error3</code>, the next state will be <code class="language-inline-text">Fail State 1</code>.
Conversely, if the Lambda throws errors like <code class="language-inline-text">Error4</code> and <code class="language-inline-text">Error5</code>, <code class="language-inline-text">Fail State 2</code> will be invoked as the next state.</p>
<h2 id="input--output-management"><a href="#input--output-management" aria-hidden="true"><span class="icon icon-link"></span></a>Input &#x26; Output management</h2>
<p>Each state’s input and output are in JSON format.</p>
<ul>
<li><strong>Parameters</strong> allow us to define the Payload for the Lambda function and pass information about associated AWS resources.
If you declare a Payload variable, the Lambda’s output will be written to that variable.</li>
<li>The <strong>InputPath</strong> filter selects a specific portion of the payload.
For instance, setting the <strong>$.transcription</strong> value in the <strong>InputPath</strong> allows the Lambda function to receive the transcription field’s value from the payload.</li>
<li><strong>ResultSelector</strong> is used to choose specific fields from the Lambda output.
The resulting data is written to the field set by the <strong>ResultPath</strong>.
For example, if you set the <strong>ResultPath</strong> value to <strong>$.output</strong>, the output of <strong>ResultSelector</strong> will be placed inside the output field, combining it with the input payload.</li>
</ul>
<p>Now, let’s see how we automated batch transcription from creation to fetching. We used four Lambdas:</p>
<ul>
<li>One to create a transcription</li>
<li>One to check the transcription status</li>
<li>One to get the transcription files</li>
<li>One to process the transcription links</li>
</ul>
<p>All API clients and business logic within the Lambdas are written in Python.
We use the <strong>requests</strong> package for making HTTP calls and <strong>boto3</strong> for AWS operations.
We have added a retry mechanism for both the <strong>requests</strong> and <strong>boto3</strong> clients.</p>
<p>Now, let’s see how we assembled the Lambdas in our Step Function to enable batch transcription functionality.</p>
<figure><img src="/blog/batch-transcription/step.webp" alt="Step function workflow"><figcaption>Step function workflow</figcaption></figure>
<p>Let’s discuss the various step function states we have used here,</p>
<h3 id="1-create-transcription-state"><a href="#1-create-transcription-state" aria-hidden="true"><span class="icon icon-link"></span></a>1. Create Transcription state</h3>
<p>This Task state invokes the <strong>Create Transcription Lambda</strong>, which implements the logic to initiate batch transcription for a pre-defined list of audio recording URLs.
The Lambda function then returns the transcription ID as its output.</p>
<h3 id="2-wait-state"><a href="#2-wait-state" aria-hidden="true"><span class="icon icon-link"></span></a>2. Wait state</h3>
<p>The Wait state is used to pause a particular state for N seconds.
In our case, we need to wait for the transcription job to complete before we can fetch the results.
Therefore, we invoke the <strong>Get Transcription Status</strong> state every N seconds.</p>
<div class="gridsome-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"Wait"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"Wait"</span><span class="token punctuation">,</span>
  <span class="token property">"Seconds"</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
  <span class="token property">"Next"</span><span class="token operator">:</span> <span class="token string">"Get Transcription Status"</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="3-get-transcription-status-state"><a href="#3-get-transcription-status-state" aria-hidden="true"><span class="icon icon-link"></span></a>3. Get transcription status state</h3>
<p>This is a Task state that invokes the <strong>Get transcription status Lambda</strong>. It contains the logic for fetching the transcription status and returns the status in the output.</p>
<h3 id="4-choice-state"><a href="#4-choice-state" aria-hidden="true"><span class="icon icon-link"></span></a>4. Choice state</h3>
<p>Choice states function similarly to switch statements, allowing you to route the flow to appropriate states based on input values.
In our Choice state, the input is the transcription status.
If the status is <strong>running</strong>, the flow returns to the <strong>Wait</strong> state (this combination of Choice and Wait states enables us to simulate a loop flow within the state machine).
If the status is <strong>succeeded</strong>, the flow progresses to the <strong>Get Transcription Files state</strong>. For any other status value, the flow defaults to the <strong>Fail</strong> state.</p>
<div class="gridsome-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"Choice"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"Choice"</span><span class="token punctuation">,</span>
  <span class="token property">"Choices"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Variable"</span><span class="token operator">:</span> <span class="token string">"$.output.status"</span><span class="token punctuation">,</span>
      <span class="token property">"StringEquals"</span><span class="token operator">:</span> <span class="token string">"Running"</span><span class="token punctuation">,</span>
      <span class="token property">"Next"</span><span class="token operator">:</span> <span class="token string">"Wait"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Variable"</span><span class="token operator">:</span> <span class="token string">"$.output.status"</span><span class="token punctuation">,</span>
      <span class="token property">"StringEquals"</span><span class="token operator">:</span> <span class="token string">"Succeeded"</span><span class="token punctuation">,</span>
      <span class="token property">"Next"</span><span class="token operator">:</span> <span class="token string">"Get transcription files"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"Default"</span><span class="token operator">:</span> <span class="token string">"Fail"</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="5-get-transcription-files-state"><a href="#5-get-transcription-files-state" aria-hidden="true"><span class="icon icon-link"></span></a>5. Get transcription files state</h3>
<p>This state contains the <strong>Get Transcription Files Lambda</strong>.
The Get Transcription Files Lambda retrieves the transcription results and returns a list of links,
each containing either the transcription report or the transcription data.</p>
<h3 id="6-map-state"><a href="#6-map-state" aria-hidden="true"><span class="icon icon-link"></span></a>6. Map state</h3>
<p>The Map state executes tasks concurrently.
It accepts a list of items as input, and you can define task states to process each item in parallel.
In our case, we’ve defined the <strong>Process Transcription</strong> state to handle the transcription results.
The Map state comes in two variants: <strong>INLINE</strong> and <strong>DISTRIBUTED</strong>.
You can use <strong>INLINE</strong> if the number of concurrent iterations won’t exceed 40.</p>
<div class="gridsome-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"Map"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"Map"</span><span class="token punctuation">,</span>
  <span class="token property">"ItemProcessor"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"ProcessorConfig"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"INLINE"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"StartAt"</span><span class="token operator">:</span> <span class="token string">"Process transcription"</span><span class="token punctuation">,</span>
    <span class="token property">"States"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"Process transcription"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"Task"</span><span class="token punctuation">,</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"error handler"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"Pass"</span><span class="token punctuation">,</span> ...<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"End"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="7-process-transcription-state"><a href="#7-process-transcription-state" aria-hidden="true"><span class="icon icon-link"></span></a>7. Process transcription state</h3>
<p>This is a Task state that invokes the <strong>Process Transcription Lambda</strong>.
The Process Transcription Lambda function downloads, formats, and saves the results to our system.</p>
<h3 id="8-error-handler-state"><a href="#8-error-handler-state" aria-hidden="true"><span class="icon icon-link"></span></a>8. Error handler state</h3>
<p>The Map state includes an error handler state.
If an unknown runtime exception occurs during any concurrent iteration, the Map state would typically stop the entire iteration.
For example, imagine you have 10 concurrent iterations and one of them fails.
In such a scenario, the Map state might halt all other executions.
To prevent this, we’ve defined an error handler state that acts as a Pass state.
This mechanism provides a fallback in case of failures, allowing other iterations to continue processing.</p>
<div class="gridsome-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"error handler"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"Pass"</span><span class="token punctuation">,</span>
  <span class="token property">"End"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="9-fail-state"><a href="#9-fail-state" aria-hidden="true"><span class="icon icon-link"></span></a>9. Fail state</h3>
<p>The Fail state in the Step Function flow is used to capture failures.
There are scenarios where you need to divert the flow to this state.
For example, if any error occurs in the Create Transcription, Get Transcription Status, or Get Transcription Files states, we set the next step as the Fail state.
An explicit Fail state allows you to set up CloudWatch alarms, collect metrics, and perform other actions in response to failures.</p>
<div class="gridsome-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"Fail"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"Fail"</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Step Functions are a powerful tool for orchestrating Lambda invocations.
While Azure Batch Transcription can accept 300 requests per minute, each request is limited to around 1,000 recording files.
To bring transcription results into your system quickly and efficiently,
it’s recommended to split your audio files into batches of 10–15 recordings each and make multiple Create Transcription calls.
This approach effectively manages Azure Batch Transcription’s request limits while ensuring a smooth, efficient workflow for your audio data.</p>
<p><strong>Note</strong>: We used polling to periodically check the transcription status due to business logic constraints. While our approach is functional, Azure Cognitive Service web hooks offer an alternative solution.</p>
<h1 id="toc-section-4"><a href="#conclusion" aria-hidden="true"><span class="icon icon-link"></span></a>Conclusion</h1>
<p>In this post, we explored Azure Batch Transcription APIs and demonstrated how Step Functions can orchestrate Lambdas for seamless data transcription.
That’s a wrap! Thanks for reading!</p>
<h2 id="references"><a href="#references" aria-hidden="true"><span class="icon icon-link"></span></a>References:</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/ai-services/speech-service/rest-speech-to-text" target="_blank" rel="nofollow noopener noreferrer">STT Rest API</a></li>
<li><a href="https://eastus.dev.cognitive.microsoft.com/docs/services/speech-to-text-api-v3-1/operations/Transcriptions_Create" target="_blank" rel="nofollow noopener noreferrer">Create Transcription API</a></li>
<li><a href="https://eastus.dev.cognitive.microsoft.com/docs/services/speech-to-text-api-v3-1/operations/Transcriptions_ListFiles" target="_blank" rel="nofollow noopener noreferrer">Get Transcription Files API</a></li>
<li><a href="https://eastus.dev.cognitive.microsoft.com/docs/services/speech-to-text-api-v3-1/operations/Transcriptions_Get" target="_blank" rel="nofollow noopener noreferrer">Get Transcription API</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/ai-services/speech-service/speech-services-quotas-and-limits#batch-transcription" target="_blank" rel="nofollow noopener noreferrer">Batch Transcription Quota</a></li>
<li><a href="https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html" target="_blank" rel="nofollow noopener noreferrer">AWS step function</a></li>
<li><a href="https://docs.aws.amazon.com/step-functions/latest/dg/sample-project-job-poller.html" target="_blank" rel="nofollow noopener noreferrer">Step function polling template</a></li>
<li><a href="https://docs.aws.amazon.com/lambda/" target="_blank" rel="nofollow noopener noreferrer">AWS Lambda</a></li>
<li><a href="https://docs.aws.amazon.com/step-functions/latest/dg/input-output-inputpath-params.html" target="_blank" rel="nofollow noopener noreferrer">Step function input &#x26; output processing</a></li>
<li><a href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-map-process-modes.html" target="_blank" rel="nofollow noopener noreferrer">Map state</a></li>
</ul>
</div><hr data-v-996dafb6><div class="inner-section" data-v-996dafb6><div class="author-basic-info" data-v-996dafb6><img src="/assets/img/k7.d295c558.png" alt="Kesavan" width="64" data-v-996dafb6><div data-v-996dafb6><p class="heading-size-9 capitalize" data-v-996dafb6>Kesavan</p><p class="body-jetbrains-size-10" data-v-996dafb6>
            Developer
          </p></div></div><p class="body-opensans-size-9" data-v-996dafb6>He is still thinking what to write about him</p><div class="social-links" data-v-996dafb6><!----><!----><a href="https://medium.com/@itzk7" target="_blank" class="heading-size-9" data-v-996dafb6>
          Medium
        </a></div></div><hr data-v-996dafb6><div class="related-articles" data-v-996dafb6><div class="flex-space-between" data-v-996dafb6><p class="heading-size-7" data-v-996dafb6>_related articles</p><a href="/blogs" class="heading-size-9 underline" data-v-996dafb6>View all</a></div><div class="flex-space-between blog-card-wrapper" data-v-996dafb6><a href="/blogs/extracting-structured-data" class="blog-card" data-v-996dafb6><img src="/assets/img/default-cover.55254b66.png" alt="Extracting Structured Data from PDFs with Claude Sonnet and Amazon Bedrock" class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/AI</p><h3 data-v-996dafb6>Extracting Structured Data from PDFs with Claude Sonnet and Amazon Bedrock</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Kesavan   7 min read
            </p></div></a><a href="/blogs/building-a-facial-recognition-machine-learning-model" class="blog-card" data-v-996dafb6><img src="/assets/img/1.41951ccc.webp" alt="Person of Interest: How I built a Facial Recognition Machine Learning model." class="thumbnail" data-v-996dafb6><div class="info" data-v-996dafb6><p class="heading-size-10 capitalize" data-v-996dafb6>/AI</p><h3 data-v-996dafb6>Person of Interest: How I built a Facial Recognition Machine Learning model.</h3><p class="body-jetbrains-size-10" data-v-996dafb6>
              Rajiv Manivannan   5 min read
            </p></div></a></div></div><div class="lets-talk" data-v-188e6a71><div class="message heading-size-7" data-v-188e6a71>
    Let’s build digital solutions together.
  </div><div class="action-container" data-v-188e6a71><div class="action-button heading-size-5" data-v-188e6a71><div data-v-188e6a71>Get in touch</div><div class="arrow" data-v-188e6a71>-&gt;</div></div><img src="/assets/img/talk.71d1d2f3.svg" alt="Lenny Face" data-v-188e6a71></div></div></div></div><div data-v-996dafb6></div></div><div id="footer" class="baseLayout" data-v-996dafb6 data-v-b5a9baaa><div data-v-996dafb6></div><div data-v-996dafb6><div class="site-footer" data-v-0a037a4b data-v-b5a9baaa><ul class="main-nav footer" data-v-04879724 data-v-0a037a4b><div class="primary fadeIn" data-v-04879724><li data-v-04879724><a href="/genai" data-v-04879724>/GenAI</a></li><li data-v-04879724><a href="https://solutions.tarkalabs.com/design/" target="_self" data-v-04879724>/Design</a></li><li data-v-04879724><a href="/develop" data-v-04879724>/Develop</a></li><li data-v-04879724><a href="/case-studies" data-v-04879724>
        /Case_Studies
      </a></li><li data-v-04879724><a href="/careers" data-v-04879724>/Careers</a></li><li data-v-04879724><a href="/about" data-v-04879724>/About</a></li><li data-v-04879724><a href="/contact" data-v-04879724>/Contact</a></li></div></ul><div class="subnav" data-v-0a037a4b><ul class="sub body-jetbrains-size-11 footer fadeIn" data-v-3cc3824e data-v-0a037a4b><li data-v-3cc3824e><a href="/blogs" class="active" data-v-3cc3824e>/blogs</a></li><li data-v-3cc3824e><a href="/talks" data-v-3cc3824e>/talks</a></li><li data-v-3cc3824e><a href="/train" data-v-3cc3824e>/train</a></li></ul><div data-v-fae945d8 data-v-0a037a4b><a href="https://twitter.com/tarkalabs" target="_blank" rel="noopener" class="external" data-v-fae945d8>Twitter</a><a href="https://in.linkedin.com/company/tarka-labs" target="_blank" rel="noopener" class="external" data-v-fae945d8>LinkedIn</a></div><div class="sedin" data-v-0a037a4b><a href="https://sedintechnologies.com/" target="_blank" rel="noopener" class="external" data-v-0a037a4b>Tarka Labs is a division of Sedin Technologies</a></div></div></div></div><div data-v-996dafb6></div></div></div></div></div>
    <script src="/assets/js/app.dd4f7263.js" defer></script><script src="/assets/js/page--src--templates--blog-vue.cebd2415.js" defer></script><script data-vue-tag="ssr" src="https://unpkg.com/@lottiefiles/lottie-player@0.4.0/dist/lottie-player.js" data-body="true"></script>
  </body>
</html>
