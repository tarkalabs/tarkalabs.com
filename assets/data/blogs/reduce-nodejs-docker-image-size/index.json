{"hash":"2c524a34610b4969d5c94d7216ed04c1e31bedf3","data":{"blog":{"id":"066a7ae6c023cb11698fcd8b0837bddd","slug":"reduce-nodejs-docker-image-size","content":"<img src=\"/blog/reduce-nodejs-docker-image-size/how-to-reduce.gif\">\n<p>Who wouldn’t love a small production image, right? If you’re looking for a way to make your images smaller, here’s how you can do it. To illustrate this further, I’ve used one of our node images with an initial size of <code class=\"language-inline-text\">1.6GB</code>. By simply following the below mentioned steps, I have reduced its size to <code class=\"language-inline-text\">450MB</code> and made it almost <code class=\"language-inline-text\">~71%</code> more space efficient now.</p>\n<h1 id=\"moving-to-alpine-images\"><a href=\"#moving-to-alpine-images\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Moving to Alpine images</h1>\n<p>The first step in reducing the image size is to move the base image from Node to Node Alpine. For example, if you’re using Node v16, you can use <code class=\"language-inline-text\">node:16-alpine</code> image as your base image, which will have a size of <code class=\"language-inline-text\">~39MB</code>, instead of a<code class=\"language-inline-text\">node:16</code> image, which would have a size of <code class=\"language-inline-text\">~332MB</code>.</p>\n<p>By just changing the base image to Alpine, you can reduce almost <code class=\"language-inline-text\">293MB</code> of size from your final image.</p>\n<p>But here’s a note of caution. Although you might reduce the image size, moving to Alpine/slim images might break the application, as these images might not have all the packages like full Node images. Please perform complete end-to-end testing after changing the base image.</p>\n<h1 id=\"utilising-docker-multi-stage-build\"><a href=\"#utilising-docker-multi-stage-build\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Utilising docker multi-stage build</h1>\n<p>Sometimes, you might need to install packages to support building the application. For example, you’ll need to install <code class=\"language-inline-text\">g++</code>, <code class=\"language-inline-text\">make</code> and <code class=\"language-inline-text\">python3</code> so that <code class=\"language-inline-text\">node-gyp</code> can build the native modules.</p>\n<p>But you don’t need these packages during the application runtime, so use docker multi-stage build to simply skip these packages in the final image.</p>\n<h1 id=\"copying-only-the-production-required-node-modules\"><a href=\"#copying-only-the-production-required-node-modules\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Copying only the production-required Node modules</h1>\n<p>For the application runtime, you don’t need any of the dev dependencies. Instead, you can simply install production node modules.</p>\n<p>As <code class=\"language-inline-text\">npm install</code> will download all the node modules, you can do <code class=\"language-inline-text\">npm prune</code> --production to remove all dev dependencies after you build your application. Or else you can simply do npm <code class=\"language-inline-text\">install --only</code> prod if your nodejs application can’t be built explicitly.</p>\n<h1 id=\"copying-only-the-required-files-to-the-final-image\"><a href=\"#copying-only-the-required-files-to-the-final-image\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Copying only the required files to the final image</h1>\n<p>Once the project is built, you can simply copy the below mentioned files to the final image. You don’t need dev dependencies or any other intermediate files from the builder stage.</p>\n<ul>\n<li>Application resources if any</li>\n<li>Package.json &#x26; package-lock.json</li>\n<li>Production only node_modules from docker builder stage</li>\n<li>Build output from docker builder stage</li>\n</ul>\n<h1 id=\"heres-the-full-nodejs-dockerfile-at-a-glance\"><a href=\"#heres-the-full-nodejs-dockerfile-at-a-glance\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Here’s the full nodejs dockerfile at a glance</h1>\n<div class=\"gridsome-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:16.4-alpine3.14 <span class=\"token keyword\">as</span> builder</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token comment\"># g++ make python3 required by node-gyp</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk add --no-cache g++ make python3</span>\n<span class=\"token comment\"># Installs required node packages</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> package*.json .npmrc /app/</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm install</span>\n<span class=\"token comment\"># Builds node application</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . .</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm run build &amp;&amp; npm prune --production</span>\n<span class=\"token comment\"># ==== Final Image</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:16.4-alpine3.14 <span class=\"token keyword\">as</span> final</span>\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> node:node</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token comment\"># Copying required resources</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--chown</span><span class=\"token punctuation\">=</span><span class=\"token string\">node:node</span></span> resources resources</span>\n<span class=\"token comment\"># Copying build output</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span> <span class=\"token property\">--chown</span><span class=\"token punctuation\">=</span><span class=\"token string\">node:node</span></span> /app/package*.json ./</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span> <span class=\"token property\">--chown</span><span class=\"token punctuation\">=</span><span class=\"token string\">node:node</span></span> /app/build/ build</span>\n<span class=\"token comment\"># Copying production only node modules</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span> <span class=\"token property\">--chown</span><span class=\"token punctuation\">=</span><span class=\"token string\">node:node</span></span> /app/node_modules/ node_modules</span>\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"node\"</span>, <span class=\"token string\">\"build/src/server.js\"</span>]</span></code></pre></div>\n<h1 id=\"some-tips-to-improve-your-build-time-further\"><a href=\"#some-tips-to-improve-your-build-time-further\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Some tips to improve your build time further</h1>\n<ul>\n<li>Before copying the entire source code, copying only <code class=\"language-inline-text\">package.json</code>, <code class=\"language-inline-text\">package-lock.json</code> and then running <code class=\"language-inline-text\">npm install</code> will speed up the subsequent builds.</li>\n<li>Before copying the build output and node modules, copy the required application resources if you have any. This way, docker won’t rebuild the layer if the file content doesn’t change.</li>\n</ul>\n<h1 id=\"all-done-here-are-some-next-steps\"><a href=\"#all-done-here-are-some-next-steps\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>All done? Here are some next steps</h1>\n<p>With just the above simple steps, you can reduce your image size by a minimum of 70% or more. Run all your unit and performance tests before you push your image to production.</p>\n<ul>\n<li>Use the <a href=\"https://github.com/wagoodman/dive#dive\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Dive</a> tool to see where exactly your image size can be reduced. The tool’s UI visualises which files are created / modified between the layers.</li>\n<li>Try to dig deeper into the application dependencies and see if you can remove unused dependencies.</li>\n<li>See which node modules have more size using <code class=\"language-inline-text\">du</code> and try to remove the unnecessary ones.</li>\n<li>Always try to use specific package(s) instead of the whole package. Ex: <code class=\"language-inline-text\">@aws-sdk/client-s3</code> instead of <code class=\"language-inline-text\">aws-sdk</code>.</li>\n<li>If you are thinking about security, moving to <a href=\"https://github.com/GoogleContainerTools/distroless\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">distroless</a> images will reduce your application attack surface significantly.</li>\n</ul>\n<p>Adding our screenshots of Dive tool for both images.</p>\n<figure><img src=\"/blog/reduce-nodejs-docker-image-size/how-to-reduce_2.webp\" alt=\"Initial image layers and their sizes\"><figcaption>Initial image layers and their sizes</figcaption></figure>\n<figure><img src=\"/blog/reduce-nodejs-docker-image-size/how-to-reduce-3.webp\" alt=\"Final image layers and their sizer\"><figcaption>Final image layers and their sizer</figcaption></figure>\n<hr>\n<p>Oh, and this is my very first article. Any feedback is welcome!</p>\n<blockquote>\n<p>Hello Montreal! We’ll be at the <a href=\"https://startupfestival.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Startupfest ’22</a> all three days, so drop by and say hi. We’d love to see what you’re building, and early birds get a free (limited) design audit or tech consultation. DM us on Twitter <a href=\"https://twitter.com/tarkalabs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">(@tarkalabs)</a> and let’s talk.</p>\n</blockquote>\n"},"blogs":{"edges":[{"node":{"tag":"web","title":"Neovim as a java IDE","description":"Neovim as a java IDE","duration":"5 min read","thumbnail_alt":"Neovim as a java IDE","slug":"neovim-as-java-ide","tarkan":{"name":"Dhruva Sagar","role":"Developer","image":"dhruva.jpg","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@dhruvasagar"}},"coverImage":""}},{"node":{"tag":"consulting","title":"Navigating Change: The BA's Role in Managing Agile Transformations","description":"Navigating change: The BA's Role in Managing Agile Transformations","duration":"3 min read","thumbnail_alt":"Navigating change: The BA's Role in Managing Agile Transformations","slug":"navigating-change","tarkan":{"name":"Sparsh Gupta","role":"Product Owner","image":"sparsh.png","blurb":"She is still thinking what to write about her","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@sparsh28"}},"coverImage":"navigating-change/navigating-change.webp"}},{"node":{"tag":"ai","title":"Extracting Structured Data from PDFs with Claude Sonnet and Amazon Bedrock","description":"Extracting Structured Data from PDFs with Claude Sonnet and Amazon Bedrock","duration":"7 min read","thumbnail_alt":"Extracting Structured Data from PDFs with Claude Sonnet and Amazon Bedrock","slug":"extracting-structured-data","tarkan":{"name":"Kesavan","role":"Developer","image":"k7.png","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@itzk7"}},"coverImage":""}},{"node":{"tag":"web","title":"Leveraging DTO pattern in Go-based web apps","description":"Leveraging DTO pattern in Go-based web apps","duration":"4 min read","thumbnail_alt":"Leveraging DTO pattern in Go-based web apps","slug":"go-dto-pattern","tarkan":{"name":"Shamil Siddique","role":"Developer","image":"shamil.png","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@shamilsdq"}},"coverImage":"go-dto-pattern/go-dto-pattern.webp"}},{"node":{"tag":"web","title":"Handling message duplication in Kafka","description":"Handling message duplication in Kafka","duration":"5 min read","thumbnail_alt":"Handling message duplication in Kafka","slug":"kafka-message-duplication","tarkan":{"name":"Vignesh Ravichandran","role":"Developer","image":"vignesh.png","blurb":"","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@vignesh-ravichandran"}},"coverImage":"kafka-message-duplication/kafka-message-duplication.webp"}},{"node":{"tag":"web","title":"Generic Callbacks in Rust","description":"Generic Callbacks in Rust","duration":"3 min read","thumbnail_alt":"Generic Callbacks in Rust","slug":"generic-callbacks-rust","tarkan":{"name":"Dhruva Sagar","role":"Developer","image":"dhruva.jpg","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@dhruvasagar"}},"coverImage":"generic-callbacks-rust/generic-callbacks-rust.webp"}},{"node":{"tag":"ai","title":"Implementing Serverless Batch Transcription with AWS Step Functions and Azure AI Services","description":"Implementing Serverless Batch Transcription with AWS Step Functions and Azure AI Services","duration":"8 min read","thumbnail_alt":"Implementing Serverless Batch Transcription with AWS Step Functions and Azure AI Services","slug":"batch-transcription","tarkan":{"name":"Kesavan","role":"Developer","image":"k7.png","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@itzk7"}},"coverImage":"batch-transcription/batch-transcription.webp"}},{"node":{"tag":"mobile","title":"We tested out Kotlin Multiplatform Mobile (KMM). Here's our take.","description":"We tested out Kotlin Multiplatform Mobile (KMM). Here's our take.","duration":"3 min read","thumbnail_alt":"We tested out Kotlin Multiplatform Mobile (KMM). Here's our take.","slug":"kotlin-multiplatform-mobile","tarkan":{"name":"Ibrahim Hassan","role":"Mobile Developer","image":"ibrahim.png","blurb":"","socials":{"twitter":"","linkedin":"https://www.linkedin.com/in/mdibrahimhassan/","medium":"https://medium.com/@mdibrahimhassan"}},"coverImage":"kotlin-multiplatform-mobile/kotlin-multiplatform-mobile.webp"}},{"node":{"tag":"consulting","title":"Documentation: Yes, We Should!","description":"Imagine you recently joined a new team, and after a couple of weeks, you were assigned a bug ticket. You look at the ticket and decide to see if this issue surfaced in the past and so do a search in the bug tracking tool.","duration":"4 min read","thumbnail_alt":"A 3D image of a file folder with purple, yellow and green color rectangles for pages","slug":"documentation-yes-we-should","tarkan":{"name":"Jahangir Anwari","role":"Developer","image":"jahangir.jpeg","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@janwari"}},"coverImage":"documentation-yes-we-should/documentation-yes-we-should.png"}},{"node":{"tag":"consulting","title":"Building Serious Software","description":"Do you know what every software startup entrepreneur dreams of after they validate the market? Software that does not break with scale and is adaptable to change.","duration":"4 min read","thumbnail_alt":"A cartoon of loosely held blocks which are held by stick figures from collapsing","slug":"building-serious-software","tarkan":{"name":"Sudhakar Rayavaram","role":"Developer","image":"sudhakar.jpg","blurb":"Programming is overrated. I mean, there is more to solving a real world problem than writing code","socials":{"twitter":"","linkedin":"https://www.linkedin.com/in/sudocker/","medium":"https://medium.com/@suDocker"}},"coverImage":"building-serious-software/banner.png"}},{"node":{"tag":"consulting","title":"Wait! Don't write code yet","description":"As developers, it is necessary to understand how the code we write helps solve real-world problems. Often, it is easier to think about users while writing the application layer of code.","duration":"3 min read","thumbnail_alt":"A isometric image of a 3D maze","slug":"wait-dont-write-code-yet","tarkan":{"name":"Vidhya Desikan","role":"Developer","image":"vidhya.png","blurb":"","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@vdviddin"}},"coverImage":"wait-dont-write-code-yet/wait-dont-write-code-yet.png"}},{"node":{"tag":"consulting","title":"What does a CTO do?","description":"There has been a lot of hand-wringing and discussions about what a CTO does on the interwebs. Does a CTO write code? Does a CTO's calendar look like it is on the maker's or the manager's schedule? Does a CTO sit in on interviews?","duration":"6 min read","thumbnail_alt":"A isometric image of a balancing scale with code on one side and detective lens on the other side","slug":"what-does-a-cto-do","tarkan":{"name":"Vagmi Mudumbai","role":"Developer","image":"vagmi.jpg","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://vagmi.medium.com/"}},"coverImage":"what-does-a-cto-do/cover.png"}},{"node":{"tag":"careers","title":"A writer's guide to working in a tech consultancy","description":"A manual for writers who work with cross-functional teams or roles.","duration":"4 min read","thumbnail_alt":"A circular red shape surrounded by cubes","slug":"a-writers-guide-to-working-in-a-tech-consultancy","tarkan":{"name":"Puneetha Jagannathan","role":"Brand Communications Specialist","image":"puneetha.jpg","blurb":"She is still thiking what to write about her","socials":{"twitter":"","linkedin":"","medium":"https://puneetha-j.medium.com/"}},"coverImage":"a-writers-guide-to-working-in-a-tech-consultancy/a-writers-guide-to-working-in-a-tech-consultancy.png"}},{"node":{"tag":"devops","title":"How to reduce your Node.js docker image size by 70%","description":"How to reduce your Node.js docker image size by 70%","duration":"4 min read","thumbnail_alt":"How to reduce your Node.js docker image size by 70%","slug":"reduce-nodejs-docker-image-size","tarkan":{"name":"Madhava Reddy SV","role":"DevOps","image":"madhava.jpg","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":""}},"coverImage":""}},{"node":{"tag":"careers","title":"Our Guide To Hiring Great People","description":"How Tarka Labs approaches hiring.","duration":"5 min read","thumbnail_alt":"Colors in geometric shapes with hand-drawn sketches on them","slug":"our-guide-to-hiring-great-people","tarkan":{"name":"Jenifa Newlin","role":"People Champion","image":"jenifa.jpg","blurb":"She is still thinking what to write about her","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@jenifa_85990"}},"coverImage":"our-guide-to-hiring-great-people/our-guide-to-hiring-great-people.png"}},{"node":{"tag":"mobile","title":"Debounce in Swift","description":"All about debounce: 4 ways to achieve debounce in Swift","duration":"5 min read","thumbnail_alt":"A representation of a function called 'debounce' which is accepting, as input, a green circle labelled '3' and outputting an identical-looking green circle with no label","slug":"debounce-in-swift","tarkan":{"name":"Pavan Kumar C","role":"iOS Developer","image":"pavan.jpg","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://pavankumarchalla.medium.com/"}},"coverImage":""}},{"node":{"tag":"web","title":"Javascript Sandbox for your Node Project","description":"Guide to safely run customer javascript code in your node.js environment using vm2.","duration":"3 min read","thumbnail_alt":"Sandbox with a pail and shovel","slug":"javascript-sandbox-for-your-node-project","tarkan":{"name":"Utkarsh Mehta","role":"Developer","image":"bitman.png","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://life-of-utkarsh.medium.com/"}},"coverImage":"javascript-sandbox-for-your-node-project/javascript-sandbox-for-your-node-project.png"}},{"node":{"tag":"web","title":"Know Kubernetes - Pictorially","description":"Understand kubernetes and its components with easily relatable pictorial representations.","duration":"7 min read","thumbnail_alt":"Black and white sketch of a square room labelled 'MASTER' with the following items: disk pack, chest of drawers with a wifi signal-emitting device on top, and two tables","slug":"know-kubernetes-pictorially","tarkan":{"name":"Sudhakar Rayavaram","role":"Developer","image":"sudhakar.jpg","blurb":"Programming is overrated. I mean, there is more to solving a real world problem than writing code","socials":{"twitter":"","linkedin":"https://www.linkedin.com/in/sudocker/","medium":"https://medium.com/@suDocker"}},"coverImage":""}},{"node":{"tag":"mobile","title":"Why flutter","description":"Look beyond react native and why flutter is exciting.","duration":"5 min read","thumbnail_alt":"A hummingbird in flight","slug":"why-flutter","tarkan":{"name":"Vagmi Mudumbai","role":"Developer","image":"vagmi.jpg","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://vagmi.medium.com/"}},"coverImage":"why-flutter/why-flutter.png"}},{"node":{"tag":"careers","title":"How we hire engineers","description":"How Tarka Labs hires engineers. Published in the interest of transparency.","duration":"3 min read","thumbnail_alt":"A dark room with two empty chairs facing each other across a table","slug":"how-we-hire-engineers","tarkan":{"name":"Vagmi Mudumbai","role":"Developer","image":"vagmi.jpg","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://vagmi.medium.com/"}},"coverImage":"how-we-hire-engineers/how-we-hire-engineers.png"}},{"node":{"tag":"web","title":"Power of SSH Tunneling","description":"Most developers spend a considerable amount of their time ssh'd into remote machines, however, few are aware of the power of ssh tunnels.","duration":"4 min read","thumbnail_alt":"Silhouette of a man standing inside a glowing blue tunnel with a glowing white circle in front of him","slug":"power-of-ssh-tunneling","tarkan":{"name":"Dhruva Sagar","role":"Developer","image":"dhruva.jpg","blurb":"He is still thinking what to write about him","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@dhruvasagar"}},"coverImage":"power-of-ssh-tunneling/power-of-ssh-tunneling.png"}},{"node":{"tag":"careers","title":"All in one's mind.","description":"The effectiveness of a positive mindset and the ability to self-assess.","duration":"4 min read","thumbnail_alt":"A growing plant is layered over the artwork of a human brain","slug":"all-in-ones-mind","tarkan":{"name":"Ramya Raghavan","role":"A tarkan","image":"bitman.png","blurb":"She is still thiking what to write about her","socials":{"twitter":"","linkedin":"","medium":"https://medium.com/@ramyaraghavan"}},"coverImage":"all-in-ones-mind/onion.webp"}}]}},"context":{}}